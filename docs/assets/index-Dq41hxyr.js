import{j as e,R as k,r as C}from"./react-ClING0Yz.js";import{a as $e}from"./react-dom-CIJYKD-W.js";import{c as M}from"./zustand-Dv4DZm5L.js";import{B as F,S as Pe,a as Te,b as Fe,D as V,c as X,d as Y,T as Q,e as ee,f as P,A as Re,g as Ue,h as L,I as G,i as Be,P as Me,L as re,j as oe,k as ie,l as Ke,m as T,C as ze,n as ae,E as We,H as Ge,o as _e,p as Je,u as W,q as He,s as qe,r as Qe}from"./@mui-DlaYunHY.js";import{u as le,a as ke,Q as Ze,M as Ve,b as Xe,c as Ye}from"./@tanstack-GiTF7lbd.js";import{S as J}from"./@radix-ui-DFM491Ig.js";import{c as ve}from"./class-variance-authority-Dp3B9jqt.js";import{c as et}from"./clsx-B-dksMZM.js";import{t as tt}from"./tailwind-merge-BZSatpsL.js";import{u as nt,a as ce,b as de,D as st,S as je,r as rt,c as ot,d as it,e as at,s as lt,K as ct,P as dt,f as be,C as ye,v as ut}from"./@dnd-kit-BFc_dNkm.js";import{u as R,a as H,b as mt}from"./jotai-BWERY_6l.js";import{a as pt}from"./axios-Dnk_-Q5K.js";import{s as Z}from"./antd-CuxWXEhW.js";import{u as gt,b as Ce,c as we}from"./react-router-DjApCZ2W.js";import{u as xt,B as ht}from"./react-router-dom-BwfcOS8W.js";import"./react-qr-code-3hBIieYD.js";import{$ as ue}from"./peerjs-DbSRqs_8.js";import{v as ft}from"./uuid-C6aID195.js";import"./@babel-CS6Uy5Jq.js";import"./scheduler-C323NY8X.js";import"./react-is-BpBQ4hf7.js";import"./react-transition-group-F5DZw6RO.js";import"./@emotion-tgIqJ5k3.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@rc-component-EO5coTpa.js";import"./@ant-design-BYsPSdCY.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-Cfq6il3H.js";import"./sdp-Bs-klj8E.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const c of u.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function l(r){if(r.ep)return;r.ep=!0;const u=n(r);fetch(r.href,u)}})();const K=t=>(i,n,l)=>t((...r)=>{console.log("  applying",r),i(...r),console.log("  new state",n())},n,l),me={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},q=M(K((t,i)=>({...me,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(me)})));function vt(t){return e.jsx(Fe,{...t,direction:"down"})}function jt(t){const{snackbar:i,closeSnackbar:n,message:l,open:r,anchorOrigin:u,autoHideDuration:c,status:s}=q(f=>f),x=e.jsx(k.Fragment,{children:e.jsx(F,{color:"inherit",size:"small",onClick:n,children:"確認"})}),m=f=>{switch(f){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx(Pe,{open:r,onClose:n,anchorOrigin:u,TransitionComponent:vt,autoHideDuration:c,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(Te,{message:s!=null?m(s):l,action:x})})})})}function $(...t){return tt(et(t))}const bt=ve("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function De({className:t,variant:i,asChild:n=!1,...l}){const r=n?J:"span";return e.jsx(r,{"data-slot":"badge",className:$(bt({variant:i}),t),...l})}const yt=ve("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function pe({className:t,variant:i,size:n,asChild:l=!1,...r}){const u=l?J:"button";return e.jsx(u,{"data-slot":"button",className:$(yt({variant:i,size:n,className:t})),...r})}const U=C.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),Ct=C.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),Se=C.createContext({listeners:void 0,isDragging:!1,disabled:!1}),wt={...at,sideEffects:it({styles:{active:{opacity:"0.4"}}})};function Dt({value:t,onValueChange:i,getItemValue:n,children:l,className:r,onMove:u}){const c=t,s=i,[x,m]=C.useState(null),f=nt(ce(dt,{activationConstraint:{distance:10}}),ce(ct,{coordinateGetter:lt})),b=C.useMemo(()=>Object.keys(c),[c]),v=C.useCallback(D=>b.includes(D),[b]),y=C.useCallback(D=>v(D)?D:b.find(I=>c[I].some(o=>n(o)===D)),[c,b,n,v]),p=C.useCallback(D=>{m(D.active.id)},[]),h=C.useCallback(D=>{if(u)return;const{active:I,over:o}=D;if(!o||v(I.id))return;const g=y(I.id),a=y(o.id);if(!g||!a||g===a)return;const d=c[g],j=c[a],E=d.findIndex(B=>n(B)===I.id);let S=j.findIndex(B=>n(B)===o.id);v(o.id)&&(S=j.length);const O=[...j],[z]=d.splice(E,1);O.splice(S,0,z),s({...c,[g]:[...d],[a]:O})},[y,n,v,s,c,u]),w=C.useCallback(D=>{const{active:I,over:o}=D;if(m(null),!o)return;if(u&&!v(I.id)){const d=y(I.id),j=y(o.id);if(d&&j){const E=c[d].findIndex(O=>n(O)===I.id),S=v(o.id)?c[j].length:c[j].findIndex(O=>n(O)===o.id);u({event:D,activeContainer:d,activeIndex:E,overContainer:j,overIndex:S})}return}if(v(I.id)&&v(o.id)){const d=b.indexOf(I.id),j=b.indexOf(o.id);if(d!==j){const E=de(Object.keys(c),d,j),S={};E.forEach(O=>{S[O]=c[O]}),s(S)}return}const g=y(I.id),a=y(o.id);if(g&&a&&g===a){const d=g,j=c[d].findIndex(S=>n(S)===I.id),E=c[d].findIndex(S=>n(S)===o.id);j!==E&&s({...c,[d]:de(c[d],j,E)})}},[b,c,y,n,v,s,u]),A=C.useMemo(()=>({columns:c,setColumns:s,getItemId:n,columnIds:b,activeId:x,setActiveId:m,findContainer:y,isColumn:v}),[c,s,n,b,x,y,v]);return e.jsx(U.Provider,{value:A,children:e.jsx(st,{sensors:f,onDragStart:p,onDragOver:h,onDragEnd:w,children:e.jsx("div",{"data-slot":"kanban","data-dragging":x!==null,className:$(r),children:l})})})}function St({children:t,className:i}){const{columnIds:n}=C.useContext(U);return e.jsx(je,{items:n,strategy:rt,children:e.jsx("div",{"data-slot":"kanban-board",className:$("grid auto-rows-fr sm:grid-cols-4 gap-4",i),children:t})})}function It({value:t,className:i,children:n,disabled:l}){const{setNodeRef:r,transform:u,transition:c,attributes:s,listeners:x,isDragging:m}=be({id:t,disabled:l}),{activeId:f,isColumn:b}=C.useContext(U),v=f?b(f):!1,y={transition:c,transform:ye.Translate.toString(u)};return e.jsx(Ct.Provider,{value:{attributes:s,listeners:x,isDragging:v,disabled:l},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":m,"data-disabled":l,ref:r,style:y,className:$("group/kanban-column flex flex-col",m&&"opacity-50",l&&"opacity-50",i),children:n})})}function Et({value:t,asChild:i=!1,className:n,children:l,disabled:r}){const{setNodeRef:u,transform:c,transition:s,attributes:x,listeners:m,isDragging:f}=be({id:t,disabled:r}),{activeId:b,isColumn:v}=C.useContext(U),y=b?!v(b):!1,p={transition:s,transform:ye.Translate.toString(c)},h=i?J:"div";return e.jsx(Se.Provider,{value:{listeners:m,isDragging:y,disabled:r},children:e.jsx(h,{"data-slot":"kanban-item","data-value":t,"data-dragging":f,"data-disabled":r,ref:u,style:p,...x,className:$(f&&"opacity-50",r&&"opacity-50",n),children:l})})}function At({asChild:t,className:i,children:n,cursor:l=!0}){const[,r]=R(Ae),{listeners:u,isDragging:c,disabled:s}=C.useContext(Se);C.useEffect(()=>{r(c)},[c]);const x=t?J:"div";return e.jsx(x,{"data-slot":"kanban-item-handle","data-dragging":c,"data-disabled":s,...u,className:$(l&&(c?"!cursor-grabbing":"!cursor-grab"),i),children:n})}function Nt({value:t,className:i,children:n}){const{columns:l,getItemId:r}=C.useContext(U),u=C.useMemo(()=>l[t].map(r),[l,r,t]);return e.jsx(je,{items:u,strategy:ut,children:e.jsx("div",{"data-slot":"kanban-column-content",className:$("flex flex-col gap-2",i),children:n})})}function Ot({children:t,className:i}){const{activeId:n,isColumn:l}=C.useContext(U),[r,u]=C.useState(null);C.useEffect(()=>{if(n){const x=document.querySelector(`[data-slot="kanban-${l(n)?"column":"item"}"][data-value="${n}"]`);if(x){const m=x.getBoundingClientRect();u({width:m.width,height:m.height})}}else u(null)},[n]);const c={width:r==null?void 0:r.width,height:r==null?void 0:r.height},s=C.useMemo(()=>n?typeof t=="function"?t({value:n,variant:l(n)?"column":"item"}):t:null,[n,t,l]);return e.jsx(ot,{dropAnimation:wt,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:c,className:$("pointer-events-none",i,n?"!cursor-grabbing":""),children:s})})}const Lt="",$t={apiurl:Lt},{apiurl:Pt}=$t;function te({cmd:t,cmd_url:i=null,method:n="GET",type:l="json",data:r={},header:u={},fileList:c=[],fileObj:s={}}){var f,b;n=n.toUpperCase(),l=l.toLowerCase();let x=i??`${Pt}/${t}`,m={method:n,headers:{"Content-Type":"application/json",...u}};if(c.length||((f=Object.keys(s))==null?void 0:f.length)>0){let v=new FormData;m.headers["Content-Type"]="multipart/form-data",[...c].forEach(p=>{v.append("files",p)}),(b=Object.keys(s))==null||b.map(p=>{Array.isArray(s[p])?[...s[p]].forEach(w=>{v.append(p,w)}):v.append(p,s[p])}),Object.keys(r).map(p=>{v.append(p,r[p])}),r=v}switch(n){case"POST":case"PUT":case"DELETE":m.data=r;break;case"GET":m.params=r;break}return pt({method:n,url:x,...m,withCredentials:!1}).then(v=>({ok:v.status=="200"||v.status=="403",status:v.status,body:v.data})).catch(v=>{let y=v.response;if(y)return{ok:y.status=="200",status:y.status,body:y.data};throw new Error({ok:!1,status:404,body:v.message})})}const Tt=async()=>await te({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Ft=async()=>await te({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Rt=async({list:t=[]})=>await te({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),ge={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},Ie=M(K((t,i)=>({...ge,setAlert:n=>t({...ge,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Ut=t=>t.map(i=>({id:i[0],title:i[1],jiraId:i[2],des:i[3],task:i[4],priority:i[5],assignee:i[6]})),ne=H({open:!1});function Bt(){var r,u;const t=le({queryKey:["getGoogleSheetIssue"],queryFn:()=>Tt()}),i=le({queryKey:["getGoogleSheetTask"],queryFn:()=>Ft()}),n=Ut(((r=t==null?void 0:t.data)==null?void 0:r.values)||[]),l=((u=i==null?void 0:i.data)==null?void 0:u.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(Mt,{tasks:l,issues:n})})}function Ee({task:t,asHandle:i,...n}){const[,l]=R(ne),r=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>l({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"line-clamp-1 font-medium text-sm",children:t.title}),e.jsx(De,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsx("div",{className:"flex items-center text-muted-foreground text-xs",children:(t==null?void 0:t.des)||""}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(Et,{value:t.id,...n,children:i?e.jsx(At,{children:r}):r})}function xe({value:t,tasks:i,isOverlay:n,...l}){return e.jsxs(It,{value:t,...l,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(De,{variant:"secondary",children:i.length})]})}),e.jsx(Nt,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:i.map(r=>e.jsx(Ee,{task:r,asHandle:!n},r.id))})]})}const Ae=H(!1);function Mt({tasks:t,issues:i}){const[n,l]=k.useState({}),[r,u]=k.useState(!1),[c]=R(Ae),[s,x]=R(ne),{setSnackMsg:m}=q(p=>p),f=ke({mutationFn:Rt,onSuccess:()=>Z.success("success")});C.useEffect(()=>{if(Array.isArray(i)&&Array.isArray(t)){let p={};t==null||t.map(h=>{let w=h[0];p[w]=i==null?void 0:i.filter(A=>A.task==w)}),l(p)}},[i,t]),C.useEffect(()=>{var p;if(r){console.log("handle change google sheet"),u(!1);let h=[];(p=Object.keys(n))==null||p.map(w=>{let A=n[w].map(D=>[D.id,D.title,D.jiraId,D.des,w,D.priority,D.assignee]);h=h.concat(A)}),f.mutate({list:h},{onSuccess:w=>console.log(w)})}},[c]);const b=p=>{u(!0),l(p)},v=(p,h)=>{var w,A,D,I;if(p!=null&&p.id){let o=JSON.parse(JSON.stringify(n));(w=Object.keys(n))==null||w.map(a=>{o[a]=o[a].map(d=>(d==null?void 0:d.id)==(p==null?void 0:p.id)?{...d,...p}:d)});let g=[];(A=Object.keys(o))==null||A.map(a=>{let d=o[a].map(j=>[j.id,j.title,j.jiraId,j.des,a,j.priority,j.assignee]);g=g.concat(d)}),f.mutate({list:g},{onSuccess:()=>(l(o),h==null?void 0:h(!0)),onError:()=>h==null?void 0:h(!1)})}else{let o=JSON.parse(JSON.stringify(n));const g=crypto.randomUUID().split("-")[0],a=(D=t==null?void 0:t[0])==null?void 0:D[0];o[a]=o[a].concat([{...p,id:g}]);let d=[];(I=Object.keys(o))==null||I.map(j=>{let E=o[j].map(S=>[S.id,S.title,S.jiraId,S.des,j,S.priority,S.assignee]);d=d.concat(E)}),f.mutate({list:d},{onSuccess:()=>(l(o),h==null?void 0:h(!0)),onError:()=>h==null?void 0:h(!1)})}},y=(p,h)=>{var D,I;let w=JSON.parse(JSON.stringify(n));(D=Object.keys(n))==null||D.map(o=>{w[o]=w[o].filter(g=>(g==null?void 0:g.id)!=p)});let A=[];(I=Object.keys(w))==null||I.map(o=>{let g=w[o].map(a=>[a.id,a.title,a.jiraId,a.des,o,a.priority,a.assignee]);A=A.concat(g)}),f.mutate({list:A},{onSuccess:()=>(l(w),h==null?void 0:h(!0)),onError:()=>h==null?void 0:h(!1)})};return e.jsxs(e.Fragment,{children:[e.jsxs(Dt,{value:n,onValueChange:b,getItemValue:p=>p.id,children:[e.jsx(St,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(n).map(([p,h])=>e.jsx(xe,{value:p,tasks:h},p))}),e.jsx(Ot,{children:({value:p,variant:h})=>{if(h==="column"){const A=n[p]||[];return e.jsx(xe,{value:p,tasks:A,isOverlay:!0})}const w=Object.values(n).flat().find(A=>A.id===p);return w?e.jsx(Ee,{task:w}):null}})]}),!!s.open&&e.jsx(V,{open:s.open,onClose:(p,h)=>{h!=="backdropClick"&&x({open:!1})},fullWidth:!0,maxWidth:"lg",children:e.jsx(Kt,{task:s.task,onClose:()=>x({open:!1}),onOk:v,onDel:y})})]})}const Kt=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"high",assignee:""},onClose:i,onOk:n,onDel:l})=>{const[r,u]=C.useState(t),[c,s]=C.useState(!1),{setAlert:x}=Ie(),m=f=>{s(!1),f&&(i==null||i())};return e.jsxs(e.Fragment,{children:[e.jsx(X,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(Y,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(Q,{label:"Title",variant:"standard",value:(r==null?void 0:r.title)||"",disabled:c,onChange:f=>u(b=>({...b,title:f.target.value})),fullWidth:!0}),e.jsx(Q,{label:"jiraId",variant:"standard",defaultValue:(r==null?void 0:r.jiraId)||"",onChange:f=>u(b=>({...b,jiraId:f.target.value})),disabled:c,fullWidth:!0}),e.jsx(Q,{label:"Des",variant:"standard",defaultValue:(r==null?void 0:r.des)||"",onChange:f=>u(b=>({...b,des:f.target.value})),disabled:c,fullWidth:!0})]}),e.jsx(ee,{children:e.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[e.jsx("div",{children:(t==null?void 0:t.id)&&e.jsx(F,{onClick:()=>x({title:"刪除",content:"確定要刪除？",handleAgree:f=>(f==null||f(),s(!0),l(t==null?void 0:t.id,m))}),variant:"contained",color:"error",sx:{p:"8px 16px",fontWeight:"500",lineHeight:"1.25rem",fontSize:"0.875rem",textTransform:"none"},disabled:c,children:"Delete"})}),e.jsxs("div",{children:[e.jsx(pe,{onClick:i,variant:"outlined",disabled:c,children:"Cancel"}),e.jsx(pe,{onClick:()=>(s(!0),n(r,m)),disabled:c,children:"OK"})]})]})})]})},zt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};M(K((t,i)=>({...zt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const Wt={isSidebarOpen:!0},Ne=M(K((t,i)=>({...Wt,setSidebarOpen:(n=null)=>t(l=>({isSidebarOpen:n!==null?n:!l.isSidebarOpen}))}))),he={open:!1,title:"",content:null,actions:null,body:null},Gt=M(K((t,i)=>({...he,setDialog:n=>t({...he,...n,open:!0}),closeDialog:()=>t({open:!1})})));function _t(t){const{title:i,name:n,logout:l}=t,{setSidebarOpen:r}=Ne();gt();const[,u]=R(ne);return e.jsx(P,{sx:{flexGrow:1},children:e.jsx(Re,{position:"fixed",sx:{zIndex:c=>c.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Ue,{children:[e.jsx(L,{variant:"h6",component:"div",children:i}),e.jsx(P,{sx:{flexGrow:1}}),e.jsx(G,{style:{color:"white"},onClick:()=>u({open:!0}),children:e.jsx(Be,{})})]})})})}const N={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},Jt=H(!1);function Ht({roomId:t,isHost:i}){const[n,l]=C.useState(null),[r,u]=R(Jt),c=C.useRef(null),[s,x]=C.useState([]),[m,f]=C.useState([]),b=C.useRef({}),{setSnackMsg:v}=q();C.useEffect(()=>{let o;if(t)return i?(o=new ue(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(o=new ue(void 0),console.log("Joiner attempting to open Peer with a random ID")),l(o),()=>{o&&!(o!=null&&o.destroyed)&&(console.log("Destroying peer instance:",o.id),o.destroy()),l(null),x([]),f([])}},[t,i]),C.useEffect(()=>{if(!n)return;n.removeAllListeners();const o=a=>console.error("PeerJS error:",a);n.on("error",o);const g=a=>{c.current=a,a.on("open",()=>{u(!0),console.log(`DataConnection open with ${a.peer}`)}),a.on("close",()=>{u(!1),c.current=null,console.log(`DataConnection closed with ${a.peer}`)}),a.on("error",d=>{console.error(`DataConnection error with ${a.peer}:`,d),u(!1)}),a.on("data",d=>{if(i)d.type==="file-received-ack"?(console.log(`Host: ACK for file ${d.fileId}`),x(j=>j.map(E=>E.id===d.fileId?{...E,status:N.SENT}:E))):d.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${d.fileId}: ${d.error}`),x(j=>j.map(E=>E.id===d.fileId?{...E,status:N.FAILED}:E)));else if(console.log("blob in",d),d.type==="file-metadata")console.log("Joiner: Received file metadata",d),b.current[d.fileId]=d;else if(d instanceof Blob||d instanceof ArrayBuffer||d instanceof Uint8Array){let j=null;const E=Object.keys(b.current).filter(S=>!m.some(O=>O.id===S));if(E.length>0){const S=E[E.length-1];S&&b.current[S]&&(j=b.current[S])}if(j){const{fileId:S,name:O,mimeType:z,size:B}=j;console.log(`Joiner: Received blob for ${O} (ID: ${S})`);const se=d instanceof Blob?d:new Blob([d],{type:z}),Oe=URL.createObjectURL(se);f(Le=>[...Le,{id:S,name:O,type:z,size:B,blobUrl:Oe,blobObject:se,status:N.RECEIVED}]),a.send({type:"file-received-ack",fileId:S}),delete b.current[S]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else d.type==="batch-meta"&&console.log("Joiner: Received batch metadata",d)})};i?(n.on("open",a=>console.log(`Host Peer opened: ${a}`)),n.on("connection",g)):n.on("open",a=>{if(console.log(`Joiner Peer opened: ${a}`),t){const d=n.connect(t);g(d)}})},[n,t,i,m]);const y=o=>{const g=Array.from(o.target.files).map(a=>({id:ft(),name:a.name,size:a.size,type:a.type,previewUrl:URL.createObjectURL(a),status:N.SELECTED,fileObject:a}));x(a=>[...a,...g]),o.target.value=null},p=async()=>{if(!r||!c.current){alert("連線未建立!");return}const o=s.filter(g=>g.status===N.SELECTED);if(o.length===0){alert("沒有已選擇的檔案可傳送。");return}c.current.send({type:"batch-meta",totalFiles:o.length});for(const g of o){x(a=>a.map(d=>d.id===g.id?{...d,status:N.SENDING}:d));try{const a={type:"file-metadata",fileId:g.id,name:g.name,mimeType:g.type,size:g.size};c.current.send(a)}catch(a){console.error(`Host: Error sending file ${g.name}:`,a),x(d=>d.map(j=>j.id===g.id?{...j,status:N.FAILED}:j))}}for(const g of o)try{await new Promise(a=>setTimeout(a,50)),c.current.send(g.fileObject),console.log(`Host: Sent ${g.name} (ID: ${g.id})`)}catch(a){console.error(`Host: Error sending file ${g.name}:`,a),x(d=>d.map(j=>j.id===g.id?{...j,status:N.FAILED}:j))}},h=o=>{const g=m.find(a=>a.id===o);if(g){const a=document.createElement("a");a.href=g.blobUrl,a.download=g.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),f(d=>d.map(j=>j.id===o?{...j,status:N.DOWNLOADED}:j))}},w=async()=>{const o=m.filter(g=>g.status===N.RECEIVED&&g.blobUrl);if(o.length===0){v({message:"沒有可下載的新檔案。"});return}for(let g=0;g<o.length;g++){const a=o[g];console.log(`Auto-downloading ${g+1}/${o.length}: ${a.name}`),h(a.id),g<o.length-1&&await new Promise(d=>setTimeout(d,500))}v({message:`${o.length} 個檔案已開始下載。`})},A=m.some(o=>o.status===N.RECEIVED&&o.blobUrl),D=o=>{const g=s.filter(a=>a.id!==o);x(g)},I=(o,g=null)=>{switch(o){case N.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"已選擇",children:e.jsx(_e,{color:"action"})}),e.jsx(T,{title:"刪除",children:e.jsx(G,{sx:{ml:1},onClick:()=>D(g),children:e.jsx(Je,{color:"action"})})})]});case N.SENDING:return e.jsx(T,{title:"傳送中",children:e.jsx(Ge,{color:"primary",className:"animate-spin"})});case N.SENT:return e.jsx(T,{title:"已傳送",children:e.jsx(ae,{color:"success"})});case N.FAILED:return e.jsx(T,{title:"失敗",children:e.jsx(We,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(Ce,{children:e.jsx(we,{path:"/transfer",element:e.jsxs(Me,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs(L,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",i?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs(L,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),i&&e.jsxs(L,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs(L,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${r?"bg-green-500":"bg-red-500"}`,children:r?"已連線":"未連線"})]})]}),i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx(L,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(F,{variant:"outlined",component:"label",disabled:!r,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:y})]}),e.jsx(F,{variant:"contained",color:"primary",onClick:p,disabled:!r||!s.some(o=>o.status===N.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(re,{dense:!0,children:s.map(o=>e.jsxs(oe,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.previewUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(ie,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB - 狀態: ${o.status}`}),e.jsx("div",{className:"ml-auto",children:I(o.status,o.id)})]},o.id))})]}),!i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs(L,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),m.length>0&&e.jsx(F,{variant:"contained",size:"small",startIcon:e.jsx(Ke,{}),onClick:w,disabled:!A||!r,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),m.length===0&&r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),m.length===0&&!r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),m.length>0&&e.jsx(re,{dense:!0,children:m.map(o=>e.jsxs(oe,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.blobUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(ie,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB`}),e.jsx(T,{title:"下載檔案",children:e.jsx(G,{color:"primary",onClick:()=>h(o.id),disabled:o.status===N.DOWNLOADED,children:e.jsx(ze,{})})}),o.status===N.DOWNLOADED&&e.jsx(T,{title:"已下載",children:e.jsx(ae,{color:"success",className:"ml-2"})})]},o.id))})]})]})})})})}function qt(){const[t,i]=xt(),n=t.get("roomId"),l=t.get("isHost");return e.jsxs(P,{sx:{flex:"1 1 auto"},children:[e.jsx(Ht,{roomId:n,isHost:l}),e.jsx(Ce,{children:e.jsx(we,{path:"/",element:e.jsx(Bt,{})})})]})}function Qt(t){const{title:i}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function kt(){return W("(min-width:900px)"),e.jsx(P,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(P,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(qt,{}),e.jsx(Qt,{title:null})]})})}function Zt(){const{open:t,closeAlert:i,title:n,content:l,handleAgree:r,handleDisagree:u}=Ie(c=>c);return e.jsxs(V,{open:t,onClose:i,children:[e.jsx(X,{children:n}),e.jsx(Y,{children:e.jsx(He,{sx:{whiteSpace:"pre-line"},children:l})}),e.jsxs(ee,{children:[e.jsx(F,{onClick:i,children:"取消"}),e.jsx(F,{onClick:()=>r(i),autoFocus:!0,children:"確認"})]})]})}function Vt(t){var h;const{children:i,margin:n=15,sx:l={},content_sx:r={},data:u=null,onlyProps:c=!1,noDrawer:s=!1}=t,x=((h=Ne())==null?void 0:h.isDrawerOpen)&&!s,m=W(x?"(min-width:1440px)":"(min-width:1200px)"),f=W(x?"(min-width:1232px)":"(min-width:992px)"),b=W(x?"(min-width:1008px)":"(min-width:768px)");let v=m?"1170px":f?"970px":b?"750px":"100%",y=(u==null?void 0:u.length)<3?`${100/u.length}%`:m?1170/3:f?970/3:b?750/2:v;const p={content_width:v,margin:`${n}px`,width:y,width_margin:typeof y!="string"?y-n*2:`calc(${y} - ${n*2}px)`,lg:m,md:f,xs:b};return c==!0?e.jsx(C.Fragment,{children:C.cloneElement(i,{...p})}):e.jsx(P,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...l},children:e.jsx(P,{sx:{width:v,display:"flex",flexWrap:"wrap",...r},children:C.cloneElement(i,{...p})})})}const Xt=qe(V)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function Yt(t){const{isRwdWidth:i}=t;return i?e.jsx(Vt,{onlyProps:!0,noDrawer:!0,children:e.jsx(fe,{...t})}):e.jsx(fe,{...t})}const fe=t=>{const{content_width:i,open:n,title:l,content:r,actions:u,body:c,closeDialog:s,disableScrollLock:x,fullWidth:m,fullHeight:f,maxWidth:b,fullScreen:v,isRwdWidth:y,contentProps:p={}}=t,h=y?{sx:{width:"100%",maxWidth:`${i} !important`,height:f?"100%":"auto"}}:{fullWidth:m,maxWidth:b,fullScreen:v};return e.jsxs(Xt,{onClose:s,open:n,disableScrollLock:!!x,...y?{}:h,PaperProps:{...y?h:{}},children:[e.jsxs(P,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(X,{sx:{m:0,p:0,pl:1},children:l}),e.jsx(G,{onClick:s,sx:{color:w=>w.palette.grey[500]},children:e.jsx(Qe,{})})]}),c?C.cloneElement(c,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{dividers:!0,sx:{...p},children:!!r&&C.cloneElement(r,{closeDialog:s})}),!!u&&e.jsx(ee,{children:C.cloneElement(u,{closeDialog:s})})]})]})},en=()=>{const{...t}=Gt();return e.jsxs(e.Fragment,{children:[e.jsx(_t,{title:"SAF Kanban"}),e.jsx(kt,{}),e.jsx(Zt,{}),e.jsx(jt,{}),e.jsx(Yt,{...t})]})},tn={},_=H(tn,async(t,i,n)=>{let l=t(_);i(_,{...l,...n})}),nn=()=>{const[{...t},i]=R(_),n=({key:l,body:r})=>{console.log(`apiDataAtom log (${l}):`,{...t,[l]:r}),i({[l]:r})};return{...mt(_),setApiData:n}},sn=()=>{const{setSnackMsg:t}=q(s=>s),{setApiData:i}=nn(),n=(s=[])=>{let x="";s==null||s.map((m,f)=>{x+=(f==0?"":`

`)+((m==null?void 0:m.displayName)||(m==null?void 0:m.field))+`：
`+(m==null?void 0:m.error)}),setAlert({title:"錯誤",content:x,handleAgree:m=>m()})},l=(s,x,m)=>{console.log("onError",s,x),Z.error("API發生未知錯誤")},r=async(s,x)=>{var f,b,v,y,p,h,w,A,D,I,o;((b=(f=x==null?void 0:x.queryKey)==null?void 0:f[0])==null?void 0:b[0])=="_"&&i({key:(y=(v=x==null?void 0:x.queryKey)==null?void 0:v[0])==null?void 0:y.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(p=x==null?void 0:x.options)==null?void 0:p.queryFn}});const m=((h=s==null?void 0:s.body)==null?void 0:h.status)!==null&&((w=s==null?void 0:s.body)==null?void 0:w.status)!==void 0?(A=s==null?void 0:s.body)==null?void 0:A.status:null;m!==null&&Array.isArray((D=s==null?void 0:s.body)==null?void 0:D.errorArray)?n((I=s==null?void 0:s.body)==null?void 0:I.errorArray):m!==null&&t({message:(o=s==null?void 0:s.body)==null?void 0:o.message}),!(s!=null&&s.ok)&&m==null&&!(s!=null&&s.pages)&&Z.error("API發生未知錯誤！")},u=(s,x)=>{},c=new Ze({queryCache:new Xe({onSuccess:r,onError:l,onSettled:u}),mutationCache:new Ve({onSuccess:r,onError:l}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var f,b,v,y;let m=(((f=s==null?void 0:s.body)==null?void 0:f.status)!==null&&((b=s==null?void 0:s.body)==null?void 0:b.status)!==void 0?(v=s==null?void 0:s.body)==null?void 0:v.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let p=[];(y=s==null?void 0:s.pages)==null||y.map((h,w)=>{p[w]=(h==null?void 0:h.body)||h}),m={...s,pages:p}}return m}}}});return e.jsx(Ye,{client:c,children:e.jsx(ht,{basename:"/SAF_Kanban/",children:e.jsx(en,{})})})},rn=document.getElementById("root");$e.createRoot(rn).render(e.jsx(sn,{}));
