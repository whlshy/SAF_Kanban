import{j as e,R as k,r as C}from"./react-BkCFb41Y.js";import{a as Le}from"./react-dom-BcT_u2RR.js";import{c as M}from"./zustand-DLhad_yI.js";import{B as F,S as $e,a as Pe,b as Te,D as Z,c as V,d as X,T as Q,e as Y,f as P,A as Fe,g as Re,h as L,I as G,i as Ue,P as Be,L as se,j as re,k as oe,l as Me,m as T,C as Ke,n as ie,E as ze,H as We,o as Ge,p as _e,u as W,q as Je,s as He,r as qe}from"./@mui-xlN6yUIm.js";import{u as ae,a as Qe,Q as ke,M as Ze,b as Ve,c as Xe}from"./@tanstack-DpQXpXmE.js";import{S as J}from"./@radix-ui-B08lzGHt.js";import{c as fe}from"./class-variance-authority-Dp3B9jqt.js";import{c as Ye}from"./clsx-B-dksMZM.js";import{t as et}from"./tailwind-merge-BZSatpsL.js";import{u as tt,a as le,b as ce,D as nt,S as ve,r as st,c as rt,d as ot,e as it,s as at,K as lt,P as ct,f as je,C as be,v as dt}from"./@dnd-kit-Le8HzPvy.js";import{u as R,a as H,b as ut}from"./jotai-B-Mb4bjH.js";import{a as mt}from"./axios-Dnk_-Q5K.js";import{u as gt,b as ye,c as Ce}from"./react-router-COu1yu9k.js";import{u as pt,B as xt}from"./react-router-dom-BpY5ankm.js";import"./react-qr-code-Bf0iBglm.js";import{$ as de}from"./peerjs-DxFR7Coi.js";import{v as ht}from"./uuid-C6aID195.js";import"./@babel-B_fy3T9z.js";import"./scheduler-C323NY8X.js";import"./react-is-BwqtTtay.js";import"./react-transition-group-CEW9j9Fk.js";import"./@emotion-B9jP_P4v.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-DzGuYBkV.js";import"./sdp-C8-99_ry.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const m of r)if(m.type==="childList")for(const c of m.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const m={};return r.integrity&&(m.integrity=r.integrity),r.referrerPolicy&&(m.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?m.credentials="include":r.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function l(r){if(r.ep)return;r.ep=!0;const m=n(r);fetch(r.href,m)}})();const K=t=>(i,n,l)=>t((...r)=>{console.log("  applying",r),i(...r),console.log("  new state",n())},n,l),ue={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},q=M(K((t,i)=>({...ue,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(ue)})));function ft(t){return e.jsx(Te,{...t,direction:"down"})}function vt(t){const{snackbar:i,closeSnackbar:n,message:l,open:r,anchorOrigin:m,autoHideDuration:c,status:s}=q(f=>f),x=e.jsx(k.Fragment,{children:e.jsx(F,{color:"inherit",size:"small",onClick:n,children:"確認"})}),u=f=>{switch(f){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx($e,{open:r,onClose:n,anchorOrigin:m,TransitionComponent:ft,autoHideDuration:c,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(Pe,{message:s!=null?u(s):l,action:x})})})})}function $(...t){return et(Ye(t))}const jt=fe("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function we({className:t,variant:i,asChild:n=!1,...l}){const r=n?J:"span";return e.jsx(r,{"data-slot":"badge",className:$(jt({variant:i}),t),...l})}const bt=fe("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function me({className:t,variant:i,size:n,asChild:l=!1,...r}){const m=l?J:"button";return e.jsx(m,{"data-slot":"button",className:$(bt({variant:i,size:n,className:t})),...r})}const U=C.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),yt=C.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),De=C.createContext({listeners:void 0,isDragging:!1,disabled:!1}),Ct={...it,sideEffects:ot({styles:{active:{opacity:"0.4"}}})};function wt({value:t,onValueChange:i,getItemValue:n,children:l,className:r,onMove:m}){const c=t,s=i,[x,u]=C.useState(null),f=tt(le(ct,{activationConstraint:{distance:10}}),le(lt,{coordinateGetter:at})),b=C.useMemo(()=>Object.keys(c),[c]),v=C.useCallback(D=>b.includes(D),[b]),y=C.useCallback(D=>v(D)?D:b.find(I=>c[I].some(o=>n(o)===D)),[c,b,n,v]),g=C.useCallback(D=>{u(D.active.id)},[]),h=C.useCallback(D=>{if(m)return;const{active:I,over:o}=D;if(!o||v(I.id))return;const p=y(I.id),a=y(o.id);if(!p||!a||p===a)return;const d=c[p],j=c[a],E=d.findIndex(B=>n(B)===I.id);let S=j.findIndex(B=>n(B)===o.id);v(o.id)&&(S=j.length);const O=[...j],[z]=d.splice(E,1);O.splice(S,0,z),s({...c,[p]:[...d],[a]:O})},[y,n,v,s,c,m]),w=C.useCallback(D=>{const{active:I,over:o}=D;if(u(null),!o)return;if(m&&!v(I.id)){const d=y(I.id),j=y(o.id);if(d&&j){const E=c[d].findIndex(O=>n(O)===I.id),S=v(o.id)?c[j].length:c[j].findIndex(O=>n(O)===o.id);m({event:D,activeContainer:d,activeIndex:E,overContainer:j,overIndex:S})}return}if(v(I.id)&&v(o.id)){const d=b.indexOf(I.id),j=b.indexOf(o.id);if(d!==j){const E=ce(Object.keys(c),d,j),S={};E.forEach(O=>{S[O]=c[O]}),s(S)}return}const p=y(I.id),a=y(o.id);if(p&&a&&p===a){const d=p,j=c[d].findIndex(S=>n(S)===I.id),E=c[d].findIndex(S=>n(S)===o.id);j!==E&&s({...c,[d]:ce(c[d],j,E)})}},[b,c,y,n,v,s,m]),A=C.useMemo(()=>({columns:c,setColumns:s,getItemId:n,columnIds:b,activeId:x,setActiveId:u,findContainer:y,isColumn:v}),[c,s,n,b,x,y,v]);return e.jsx(U.Provider,{value:A,children:e.jsx(nt,{sensors:f,onDragStart:g,onDragOver:h,onDragEnd:w,children:e.jsx("div",{"data-slot":"kanban","data-dragging":x!==null,className:$(r),children:l})})})}function Dt({children:t,className:i}){const{columnIds:n}=C.useContext(U);return e.jsx(ve,{items:n,strategy:st,children:e.jsx("div",{"data-slot":"kanban-board",className:$("grid auto-rows-fr sm:grid-cols-4 gap-4",i),children:t})})}function St({value:t,className:i,children:n,disabled:l}){const{setNodeRef:r,transform:m,transition:c,attributes:s,listeners:x,isDragging:u}=je({id:t,disabled:l}),{activeId:f,isColumn:b}=C.useContext(U),v=f?b(f):!1,y={transition:c,transform:be.Translate.toString(m)};return e.jsx(yt.Provider,{value:{attributes:s,listeners:x,isDragging:v,disabled:l},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":u,"data-disabled":l,ref:r,style:y,className:$("group/kanban-column flex flex-col",u&&"opacity-50",l&&"opacity-50",i),children:n})})}function It({value:t,asChild:i=!1,className:n,children:l,disabled:r}){const{setNodeRef:m,transform:c,transition:s,attributes:x,listeners:u,isDragging:f}=je({id:t,disabled:r}),{activeId:b,isColumn:v}=C.useContext(U),y=b?!v(b):!1,g={transition:s,transform:be.Translate.toString(c)},h=i?J:"div";return e.jsx(De.Provider,{value:{listeners:u,isDragging:y,disabled:r},children:e.jsx(h,{"data-slot":"kanban-item","data-value":t,"data-dragging":f,"data-disabled":r,ref:m,style:g,...x,className:$(f&&"opacity-50",r&&"opacity-50",n),children:l})})}function Et({asChild:t,className:i,children:n,cursor:l=!0}){const[,r]=R(Ee),{listeners:m,isDragging:c,disabled:s}=C.useContext(De);C.useEffect(()=>{r(c)},[c]);const x=t?J:"div";return e.jsx(x,{"data-slot":"kanban-item-handle","data-dragging":c,"data-disabled":s,...m,className:$(l&&(c?"!cursor-grabbing":"!cursor-grab"),i),children:n})}function At({value:t,className:i,children:n}){const{columns:l,getItemId:r}=C.useContext(U),m=C.useMemo(()=>l[t].map(r),[l,r,t]);return e.jsx(ve,{items:m,strategy:dt,children:e.jsx("div",{"data-slot":"kanban-column-content",className:$("flex flex-col gap-2",i),children:n})})}function Nt({children:t,className:i}){const{activeId:n,isColumn:l}=C.useContext(U),[r,m]=C.useState(null);C.useEffect(()=>{if(n){const x=document.querySelector(`[data-slot="kanban-${l(n)?"column":"item"}"][data-value="${n}"]`);if(x){const u=x.getBoundingClientRect();m({width:u.width,height:u.height})}}else m(null)},[n]);const c={width:r==null?void 0:r.width,height:r==null?void 0:r.height},s=C.useMemo(()=>n?typeof t=="function"?t({value:n,variant:l(n)?"column":"item"}):t:null,[n,t,l]);return e.jsx(rt,{dropAnimation:Ct,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:c,className:$("pointer-events-none",i,n?"!cursor-grabbing":""),children:s})})}const Ot="",Lt={apiurl:Ot},{apiurl:$t}=Lt;function ee({cmd:t,cmd_url:i=null,method:n="GET",type:l="json",data:r={},header:m={},fileList:c=[],fileObj:s={}}){var f,b;n=n.toUpperCase(),l=l.toLowerCase();let x=i??`${$t}/${t}`,u={method:n,headers:{"Content-Type":"application/json",...m}};if(c.length||((f=Object.keys(s))==null?void 0:f.length)>0){let v=new FormData;u.headers["Content-Type"]="multipart/form-data",[...c].forEach(g=>{v.append("files",g)}),(b=Object.keys(s))==null||b.map(g=>{Array.isArray(s[g])?[...s[g]].forEach(w=>{v.append(g,w)}):v.append(g,s[g])}),Object.keys(r).map(g=>{v.append(g,r[g])}),r=v}switch(n){case"POST":case"PUT":case"DELETE":u.data=r;break;case"GET":u.params=r;break}return mt({method:n,url:x,...u,withCredentials:!1}).then(v=>({ok:v.status=="200"||v.status=="403",status:v.status,body:v.data})).catch(v=>{let y=v.response;if(y)return{ok:y.status=="200",status:y.status,body:y.data};throw new Error({ok:!1,status:404,body:v.message})})}const Pt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Tt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Ft=async({list:t=[]})=>await ee({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),ge={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},Se=M(K((t,i)=>({...ge,setAlert:n=>t({...ge,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Rt=t=>t.map(i=>({id:i[0],title:i[1],jiraId:i[2],des:i[3],task:i[4],priority:i[5],assignee:i[6]})),te=H({open:!1});function Ut(){var r,m;const t=ae({queryKey:["getGoogleSheetIssue"],queryFn:()=>Pt()}),i=ae({queryKey:["getGoogleSheetTask"],queryFn:()=>Tt()}),n=Rt(((r=t==null?void 0:t.data)==null?void 0:r.values)||[]),l=((m=i==null?void 0:i.data)==null?void 0:m.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(Bt,{tasks:l,issues:n})})}function Ie({task:t,asHandle:i,...n}){const[,l]=R(te),r=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>l({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"line-clamp-1 font-medium text-sm",children:t.title}),e.jsx(we,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsx("div",{className:"flex items-center text-muted-foreground text-xs",children:(t==null?void 0:t.des)||""}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(It,{value:t.id,...n,children:i?e.jsx(Et,{children:r}):r})}function pe({value:t,tasks:i,isOverlay:n,...l}){return e.jsxs(St,{value:t,...l,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(we,{variant:"secondary",children:i.length})]})}),e.jsx(At,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:i.map(r=>e.jsx(Ie,{task:r,asHandle:!n},r.id))})]})}const Ee=H(!1);function Bt({tasks:t,issues:i}){const[n,l]=k.useState({}),[r,m]=k.useState(!1),[c]=R(Ee),[s,x]=R(te),{setSnackMsg:u}=q(g=>g),f=Qe({mutationFn:Ft});C.useEffect(()=>{if(Array.isArray(i)&&Array.isArray(t)){let g={};t==null||t.map(h=>{let w=h[0];g[w]=i==null?void 0:i.filter(A=>A.task==w)}),l(g)}},[i,t]),C.useEffect(()=>{var g;if(r){console.log("handle change google sheet"),m(!1);let h=[];(g=Object.keys(n))==null||g.map(w=>{let A=n[w].map(D=>[D.id,D.title,D.jiraId,D.des,w,D.priority,D.assignee]);h=h.concat(A)}),f.mutate({list:h},{onSuccess:w=>console.log(w)})}},[c]);const b=g=>{m(!0),l(g)},v=(g,h)=>{var w,A,D,I;if(g!=null&&g.id){let o=JSON.parse(JSON.stringify(n));(w=Object.keys(n))==null||w.map(a=>{o[a]=o[a].map(d=>(d==null?void 0:d.id)==(g==null?void 0:g.id)?{...d,...g}:d)});let p=[];(A=Object.keys(o))==null||A.map(a=>{let d=o[a].map(j=>[j.id,j.title,j.jiraId,j.des,a,j.priority,j.assignee]);p=p.concat(d)}),f.mutate({list:p},{onSuccess:()=>(l(o),h==null||h(!0),u({message:"success"})),onError:()=>h==null?void 0:h(!1)})}else{let o=JSON.parse(JSON.stringify(n));const p=crypto.randomUUID().split("-")[0],a=(D=t==null?void 0:t[0])==null?void 0:D[0];o[a]=o[a].concat([{...g,id:p}]);let d=[];(I=Object.keys(o))==null||I.map(j=>{let E=o[j].map(S=>[S.id,S.title,S.jiraId,S.des,j,S.priority,S.assignee]);d=d.concat(E)}),f.mutate({list:d},{onSuccess:()=>(l(o),h==null||h(!0),u({message:"success"})),onError:()=>h==null?void 0:h(!1)})}},y=(g,h)=>{var D,I;let w=JSON.parse(JSON.stringify(n));(D=Object.keys(n))==null||D.map(o=>{w[o]=w[o].filter(p=>(p==null?void 0:p.id)!=g)});let A=[];(I=Object.keys(w))==null||I.map(o=>{let p=w[o].map(a=>[a.id,a.title,a.jiraId,a.des,o,a.priority,a.assignee]);A=A.concat(p)}),f.mutate({list:A},{onSuccess:()=>(l(w),h==null||h(!0),u({message:"success"})),onError:()=>h==null?void 0:h(!1)})};return e.jsxs(e.Fragment,{children:[e.jsxs(wt,{value:n,onValueChange:b,getItemValue:g=>g.id,children:[e.jsx(Dt,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(n).map(([g,h])=>e.jsx(pe,{value:g,tasks:h},g))}),e.jsx(Nt,{children:({value:g,variant:h})=>{if(h==="column"){const A=n[g]||[];return e.jsx(pe,{value:g,tasks:A,isOverlay:!0})}const w=Object.values(n).flat().find(A=>A.id===g);return w?e.jsx(Ie,{task:w}):null}})]}),!!s.open&&e.jsx(Z,{open:s.open,onClose:(g,h)=>{h!=="backdropClick"&&x({open:!1})},fullWidth:!0,maxWidth:"lg",children:e.jsx(Mt,{task:s.task,onClose:()=>x({open:!1}),onOk:v,onDel:y})})]})}const Mt=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"high",assignee:""},onClose:i,onOk:n,onDel:l})=>{const[r,m]=C.useState(t),[c,s]=C.useState(!1),{setAlert:x}=Se(),u=f=>{s(!1),f&&(i==null||i())};return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(X,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(Q,{label:"Title",variant:"standard",value:(r==null?void 0:r.title)||"",disabled:c,onChange:f=>m(b=>({...b,title:f.target.value})),fullWidth:!0}),e.jsx(Q,{label:"jiraId",variant:"standard",defaultValue:(r==null?void 0:r.jiraId)||"",onChange:f=>m(b=>({...b,jiraId:f.target.value})),disabled:c,fullWidth:!0}),e.jsx(Q,{label:"Des",variant:"standard",defaultValue:(r==null?void 0:r.des)||"",onChange:f=>m(b=>({...b,des:f.target.value})),disabled:c,fullWidth:!0})]}),e.jsx(Y,{children:e.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[e.jsx("div",{children:(t==null?void 0:t.id)&&e.jsx(F,{onClick:()=>x({title:"刪除",content:"確定要刪除？",handleAgree:f=>(f==null||f(),s(!0),l(t==null?void 0:t.id,u))}),variant:"contained",color:"error",sx:{p:"8px 16px",fontWeight:"500",lineHeight:"1.25rem",fontSize:"0.875rem",textTransform:"none"},disabled:c,children:"Delete"})}),e.jsxs("div",{children:[e.jsx(me,{onClick:i,variant:"outlined",disabled:c,children:"Cancel"}),e.jsx(me,{onClick:()=>(s(!0),n(r,u)),disabled:c,children:"OK"})]})]})})]})},Kt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};M(K((t,i)=>({...Kt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const zt={isSidebarOpen:!0},Ae=M(K((t,i)=>({...zt,setSidebarOpen:(n=null)=>t(l=>({isSidebarOpen:n!==null?n:!l.isSidebarOpen}))}))),xe={open:!1,title:"",content:null,actions:null,body:null},Wt=M(K((t,i)=>({...xe,setDialog:n=>t({...xe,...n,open:!0}),closeDialog:()=>t({open:!1})})));function Gt(t){const{title:i,name:n,logout:l}=t,{setSidebarOpen:r}=Ae();gt();const[,m]=R(te);return e.jsx(P,{sx:{flexGrow:1},children:e.jsx(Fe,{position:"fixed",sx:{zIndex:c=>c.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Re,{children:[e.jsx(L,{variant:"h6",component:"div",children:i}),e.jsx(P,{sx:{flexGrow:1}}),e.jsx(G,{style:{color:"white"},onClick:()=>m({open:!0}),children:e.jsx(Ue,{})})]})})})}const N={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},_t=H(!1);function Jt({roomId:t,isHost:i}){const[n,l]=C.useState(null),[r,m]=R(_t),c=C.useRef(null),[s,x]=C.useState([]),[u,f]=C.useState([]),b=C.useRef({}),{setSnackMsg:v}=q();C.useEffect(()=>{let o;if(t)return i?(o=new de(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(o=new de(void 0),console.log("Joiner attempting to open Peer with a random ID")),l(o),()=>{o&&!(o!=null&&o.destroyed)&&(console.log("Destroying peer instance:",o.id),o.destroy()),l(null),x([]),f([])}},[t,i]),C.useEffect(()=>{if(!n)return;n.removeAllListeners();const o=a=>console.error("PeerJS error:",a);n.on("error",o);const p=a=>{c.current=a,a.on("open",()=>{m(!0),console.log(`DataConnection open with ${a.peer}`)}),a.on("close",()=>{m(!1),c.current=null,console.log(`DataConnection closed with ${a.peer}`)}),a.on("error",d=>{console.error(`DataConnection error with ${a.peer}:`,d),m(!1)}),a.on("data",d=>{if(i)d.type==="file-received-ack"?(console.log(`Host: ACK for file ${d.fileId}`),x(j=>j.map(E=>E.id===d.fileId?{...E,status:N.SENT}:E))):d.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${d.fileId}: ${d.error}`),x(j=>j.map(E=>E.id===d.fileId?{...E,status:N.FAILED}:E)));else if(console.log("blob in",d),d.type==="file-metadata")console.log("Joiner: Received file metadata",d),b.current[d.fileId]=d;else if(d instanceof Blob||d instanceof ArrayBuffer||d instanceof Uint8Array){let j=null;const E=Object.keys(b.current).filter(S=>!u.some(O=>O.id===S));if(E.length>0){const S=E[E.length-1];S&&b.current[S]&&(j=b.current[S])}if(j){const{fileId:S,name:O,mimeType:z,size:B}=j;console.log(`Joiner: Received blob for ${O} (ID: ${S})`);const ne=d instanceof Blob?d:new Blob([d],{type:z}),Ne=URL.createObjectURL(ne);f(Oe=>[...Oe,{id:S,name:O,type:z,size:B,blobUrl:Ne,blobObject:ne,status:N.RECEIVED}]),a.send({type:"file-received-ack",fileId:S}),delete b.current[S]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else d.type==="batch-meta"&&console.log("Joiner: Received batch metadata",d)})};i?(n.on("open",a=>console.log(`Host Peer opened: ${a}`)),n.on("connection",p)):n.on("open",a=>{if(console.log(`Joiner Peer opened: ${a}`),t){const d=n.connect(t);p(d)}})},[n,t,i,u]);const y=o=>{const p=Array.from(o.target.files).map(a=>({id:ht(),name:a.name,size:a.size,type:a.type,previewUrl:URL.createObjectURL(a),status:N.SELECTED,fileObject:a}));x(a=>[...a,...p]),o.target.value=null},g=async()=>{if(!r||!c.current){alert("連線未建立!");return}const o=s.filter(p=>p.status===N.SELECTED);if(o.length===0){alert("沒有已選擇的檔案可傳送。");return}c.current.send({type:"batch-meta",totalFiles:o.length});for(const p of o){x(a=>a.map(d=>d.id===p.id?{...d,status:N.SENDING}:d));try{const a={type:"file-metadata",fileId:p.id,name:p.name,mimeType:p.type,size:p.size};c.current.send(a)}catch(a){console.error(`Host: Error sending file ${p.name}:`,a),x(d=>d.map(j=>j.id===p.id?{...j,status:N.FAILED}:j))}}for(const p of o)try{await new Promise(a=>setTimeout(a,50)),c.current.send(p.fileObject),console.log(`Host: Sent ${p.name} (ID: ${p.id})`)}catch(a){console.error(`Host: Error sending file ${p.name}:`,a),x(d=>d.map(j=>j.id===p.id?{...j,status:N.FAILED}:j))}},h=o=>{const p=u.find(a=>a.id===o);if(p){const a=document.createElement("a");a.href=p.blobUrl,a.download=p.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),f(d=>d.map(j=>j.id===o?{...j,status:N.DOWNLOADED}:j))}},w=async()=>{const o=u.filter(p=>p.status===N.RECEIVED&&p.blobUrl);if(o.length===0){v({message:"沒有可下載的新檔案。"});return}for(let p=0;p<o.length;p++){const a=o[p];console.log(`Auto-downloading ${p+1}/${o.length}: ${a.name}`),h(a.id),p<o.length-1&&await new Promise(d=>setTimeout(d,500))}v({message:`${o.length} 個檔案已開始下載。`})},A=u.some(o=>o.status===N.RECEIVED&&o.blobUrl),D=o=>{const p=s.filter(a=>a.id!==o);x(p)},I=(o,p=null)=>{switch(o){case N.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"已選擇",children:e.jsx(Ge,{color:"action"})}),e.jsx(T,{title:"刪除",children:e.jsx(G,{sx:{ml:1},onClick:()=>D(p),children:e.jsx(_e,{color:"action"})})})]});case N.SENDING:return e.jsx(T,{title:"傳送中",children:e.jsx(We,{color:"primary",className:"animate-spin"})});case N.SENT:return e.jsx(T,{title:"已傳送",children:e.jsx(ie,{color:"success"})});case N.FAILED:return e.jsx(T,{title:"失敗",children:e.jsx(ze,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(ye,{children:e.jsx(Ce,{path:"/transfer",element:e.jsxs(Be,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs(L,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",i?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs(L,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),i&&e.jsxs(L,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs(L,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${r?"bg-green-500":"bg-red-500"}`,children:r?"已連線":"未連線"})]})]}),i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx(L,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(F,{variant:"outlined",component:"label",disabled:!r,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:y})]}),e.jsx(F,{variant:"contained",color:"primary",onClick:g,disabled:!r||!s.some(o=>o.status===N.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(se,{dense:!0,children:s.map(o=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.previewUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB - 狀態: ${o.status}`}),e.jsx("div",{className:"ml-auto",children:I(o.status,o.id)})]},o.id))})]}),!i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs(L,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),u.length>0&&e.jsx(F,{variant:"contained",size:"small",startIcon:e.jsx(Me,{}),onClick:w,disabled:!A||!r,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),u.length===0&&r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),u.length===0&&!r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),u.length>0&&e.jsx(se,{dense:!0,children:u.map(o=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.blobUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB`}),e.jsx(T,{title:"下載檔案",children:e.jsx(G,{color:"primary",onClick:()=>h(o.id),disabled:o.status===N.DOWNLOADED,children:e.jsx(Ke,{})})}),o.status===N.DOWNLOADED&&e.jsx(T,{title:"已下載",children:e.jsx(ie,{color:"success",className:"ml-2"})})]},o.id))})]})]})})})})}function Ht(){const[t,i]=pt(),n=t.get("roomId"),l=t.get("isHost");return e.jsxs(P,{sx:{flex:"1 1 auto"},children:[e.jsx(Jt,{roomId:n,isHost:l}),e.jsx(ye,{children:e.jsx(Ce,{path:"/",element:e.jsx(Ut,{})})})]})}function qt(t){const{title:i}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function Qt(){return W("(min-width:900px)"),e.jsx(P,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(P,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(Ht,{}),e.jsx(qt,{title:null})]})})}function kt(){const{open:t,closeAlert:i,title:n,content:l,handleAgree:r,handleDisagree:m}=Se(c=>c);return e.jsxs(Z,{open:t,onClose:i,children:[e.jsx(V,{children:n}),e.jsx(X,{children:e.jsx(Je,{sx:{whiteSpace:"pre-line"},children:l})}),e.jsxs(Y,{children:[e.jsx(F,{onClick:i,children:"取消"}),e.jsx(F,{onClick:()=>r(i),autoFocus:!0,children:"確認"})]})]})}function Zt(t){var h;const{children:i,margin:n=15,sx:l={},content_sx:r={},data:m=null,onlyProps:c=!1,noDrawer:s=!1}=t,x=((h=Ae())==null?void 0:h.isDrawerOpen)&&!s,u=W(x?"(min-width:1440px)":"(min-width:1200px)"),f=W(x?"(min-width:1232px)":"(min-width:992px)"),b=W(x?"(min-width:1008px)":"(min-width:768px)");let v=u?"1170px":f?"970px":b?"750px":"100%",y=(m==null?void 0:m.length)<3?`${100/m.length}%`:u?1170/3:f?970/3:b?750/2:v;const g={content_width:v,margin:`${n}px`,width:y,width_margin:typeof y!="string"?y-n*2:`calc(${y} - ${n*2}px)`,lg:u,md:f,xs:b};return c==!0?e.jsx(C.Fragment,{children:C.cloneElement(i,{...g})}):e.jsx(P,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...l},children:e.jsx(P,{sx:{width:v,display:"flex",flexWrap:"wrap",...r},children:C.cloneElement(i,{...g})})})}const Vt=He(Z)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function Xt(t){const{isRwdWidth:i}=t;return i?e.jsx(Zt,{onlyProps:!0,noDrawer:!0,children:e.jsx(he,{...t})}):e.jsx(he,{...t})}const he=t=>{const{content_width:i,open:n,title:l,content:r,actions:m,body:c,closeDialog:s,disableScrollLock:x,fullWidth:u,fullHeight:f,maxWidth:b,fullScreen:v,isRwdWidth:y,contentProps:g={}}=t,h=y?{sx:{width:"100%",maxWidth:`${i} !important`,height:f?"100%":"auto"}}:{fullWidth:u,maxWidth:b,fullScreen:v};return e.jsxs(Vt,{onClose:s,open:n,disableScrollLock:!!x,...y?{}:h,PaperProps:{...y?h:{}},children:[e.jsxs(P,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(V,{sx:{m:0,p:0,pl:1},children:l}),e.jsx(G,{onClick:s,sx:{color:w=>w.palette.grey[500]},children:e.jsx(qe,{})})]}),c?C.cloneElement(c,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(X,{dividers:!0,sx:{...g},children:!!r&&C.cloneElement(r,{closeDialog:s})}),!!m&&e.jsx(Y,{children:C.cloneElement(m,{closeDialog:s})})]})]})},Yt=()=>{const{...t}=Wt();return e.jsxs(e.Fragment,{children:[e.jsx(Gt,{title:"SAF Kanban"}),e.jsx(Qt,{}),e.jsx(kt,{}),e.jsx(vt,{}),e.jsx(Xt,{...t})]})},en={},_=H(en,async(t,i,n)=>{let l=t(_);i(_,{...l,...n})}),tn=()=>{const[{...t},i]=R(_),n=({key:l,body:r})=>{console.log(`apiDataAtom log (${l}):`,{...t,[l]:r}),i({[l]:r})};return{...ut(_),setApiData:n}},nn=()=>{const{setSnackMsg:t}=q(s=>s),{setApiData:i}=tn(),n=(s=[])=>{let x="";s==null||s.map((u,f)=>{x+=(f==0?"":`

`)+((u==null?void 0:u.displayName)||(u==null?void 0:u.field))+`：
`+(u==null?void 0:u.error)}),setAlert({title:"錯誤",content:x,handleAgree:u=>u()})},l=(s,x,u)=>{console.log("onError",s,x),t({message:"API發生未知錯誤"})},r=async(s,x)=>{var f,b,v,y,g,h,w,A,D,I,o;((b=(f=x==null?void 0:x.queryKey)==null?void 0:f[0])==null?void 0:b[0])=="_"&&i({key:(y=(v=x==null?void 0:x.queryKey)==null?void 0:v[0])==null?void 0:y.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(g=x==null?void 0:x.options)==null?void 0:g.queryFn}});const u=((h=s==null?void 0:s.body)==null?void 0:h.status)!==null&&((w=s==null?void 0:s.body)==null?void 0:w.status)!==void 0?(A=s==null?void 0:s.body)==null?void 0:A.status:null;u!==null&&Array.isArray((D=s==null?void 0:s.body)==null?void 0:D.errorArray)?n((I=s==null?void 0:s.body)==null?void 0:I.errorArray):u!==null&&t({message:(o=s==null?void 0:s.body)==null?void 0:o.message}),!(s!=null&&s.ok)&&u==null&&!(s!=null&&s.pages)&&t({message:"API發生未知錯誤！"})},m=(s,x)=>{},c=new ke({queryCache:new Ve({onSuccess:r,onError:l,onSettled:m}),mutationCache:new Ze({onSuccess:r,onError:l}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var f,b,v,y;let u=(((f=s==null?void 0:s.body)==null?void 0:f.status)!==null&&((b=s==null?void 0:s.body)==null?void 0:b.status)!==void 0?(v=s==null?void 0:s.body)==null?void 0:v.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let g=[];(y=s==null?void 0:s.pages)==null||y.map((h,w)=>{g[w]=(h==null?void 0:h.body)||h}),u={...s,pages:g}}return u}}}});return e.jsx(Xe,{client:c,children:e.jsx(xt,{basename:"/SAF_Kanban/",children:e.jsx(Yt,{})})})},sn=document.getElementById("root");Le.createRoot(sn).render(e.jsx(nn,{}));
