import{j as e,R as V,r as C}from"./react-BNFXmJit.js";import{a as Fe}from"./react-dom-DU2HxD6Q.js";import{c as z}from"./zustand-jdFGy96J.js";import{B as T,S as Pe,a as Te,b as Re,D as Z,T as F,c as X,d as k,e as B,f as Y,g as P,A as Ue,h as Be,i as L,I as W,j as Me,k as Ke,P as We,L as re,l as oe,m as ie,n as ze,C as _e,o as ae,E as Ge,H as Je,p as He,q as ke,u as J,r as qe,s as Qe,t as Ve}from"./@mui-DCz3MozJ.js";import{u as le,a as Ze,Q as Xe,M as Ye,b as et,c as tt}from"./@tanstack-kbhLBQrR.js";import{S as q}from"./@radix-ui-290z3nzd.js";import{c as je}from"./class-variance-authority-Dp3B9jqt.js";import{c as nt}from"./clsx-B-dksMZM.js";import{t as st}from"./tailwind-merge-BZSatpsL.js";import{u as rt,a as ce,b as de,D as ot,S as ve,r as it,c as at,d as lt,e as ct,s as dt,K as ut,P as gt,f as be,C as ye,v as mt}from"./@dnd-kit-DLTCmjbs.js";import{u as R,a as Q,b as pt}from"./jotai-jVEcPyGV.js";import{a as ht}from"./axios-Dnk_-Q5K.js";import{s as U,C as xt}from"./antd-BLsR4uZN.js";import{u as ft,b as Ce,c as we}from"./react-router-B5Odlf6b.js";import{u as jt,B as vt}from"./react-router-dom-CM_1JYDE.js";import"./react-qr-code-C7f_KUQ-.js";import{$ as ue}from"./peerjs-CufFWV83.js";import{v as bt}from"./uuid-C6aID195.js";import"./@babel-DJWSDDF_.js";import"./scheduler-C323NY8X.js";import"./react-is-BpBQ4hf7.js";import"./react-transition-group-DBecVdFz.js";import"./@emotion-CJpBmTSL.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@rc-component-CtoK-NNf.js";import"./@ant-design-Cfo3f-kr.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-CRxAxDsU.js";import"./sdp-Y7wP_hIt.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const l of d.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(r){if(r.ep)return;r.ep=!0;const d=n(r);fetch(r.href,d)}})();const _=t=>(i,n,a)=>t((...r)=>{console.log("  applying",r),i(...r),console.log("  new state",n())},n,a),ge={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},ee=z(_((t,i)=>({...ge,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(ge)})));function yt(t){return e.jsx(Re,{...t,direction:"down"})}function Ct(t){const{snackbar:i,closeSnackbar:n,message:a,open:r,anchorOrigin:d,autoHideDuration:l,status:s}=ee(f=>f),h=e.jsx(V.Fragment,{children:e.jsx(T,{color:"inherit",size:"small",onClick:n,children:"確認"})}),g=f=>{switch(f){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx(Pe,{open:r,onClose:n,anchorOrigin:d,TransitionComponent:yt,autoHideDuration:l,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(Te,{message:s!=null?g(s):a,action:h})})})})}function $(...t){return st(nt(t))}const wt=je("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function Se({className:t,variant:i,asChild:n=!1,...a}){const r=n?q:"span";return e.jsx(r,{"data-slot":"badge",className:$(wt({variant:i}),t),...a})}const St=je("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function me({className:t,variant:i,size:n,asChild:a=!1,...r}){const d=a?q:"button";return e.jsx(d,{"data-slot":"button",className:$(St({variant:i,size:n,className:t})),...r})}const M=C.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),Dt=C.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),De=C.createContext({listeners:void 0,isDragging:!1,disabled:!1}),It={...ct,sideEffects:lt({styles:{active:{opacity:"0.4"}}})};function Et({value:t,onValueChange:i,getItemValue:n,children:a,className:r,onMove:d}){const l=t,s=i,[h,g]=C.useState(null),f=rt(ce(gt,{activationConstraint:{distance:10}}),ce(ut,{coordinateGetter:dt})),b=C.useMemo(()=>Object.keys(l),[l]),j=C.useCallback(D=>b.includes(D),[b]),y=C.useCallback(D=>j(D)?D:b.find(I=>l[I].some(o=>n(o)===D)),[l,b,n,j]),p=C.useCallback(D=>{g(D.active.id)},[]),x=C.useCallback(D=>{if(d)return;const{active:I,over:o}=D;if(!o||j(I.id))return;const m=y(I.id),c=y(o.id);if(!m||!c||m===c)return;const u=l[m],v=l[c],E=u.findIndex(K=>n(K)===I.id);let w=v.findIndex(K=>n(K)===o.id);j(o.id)&&(w=v.length);const O=[...v],[G]=u.splice(E,1);O.splice(w,0,G),s({...l,[m]:[...u],[c]:O})},[y,n,j,s,l,d]),S=C.useCallback(D=>{const{active:I,over:o}=D;if(g(null),!o)return;if(d&&!j(I.id)){const u=y(I.id),v=y(o.id);if(u&&v){const E=l[u].findIndex(O=>n(O)===I.id),w=j(o.id)?l[v].length:l[v].findIndex(O=>n(O)===o.id);d({event:D,activeContainer:u,activeIndex:E,overContainer:v,overIndex:w})}return}if(j(I.id)&&j(o.id)){const u=b.indexOf(I.id),v=b.indexOf(o.id);if(u!==v){const E=de(Object.keys(l),u,v),w={};E.forEach(O=>{w[O]=l[O]}),s(w)}return}const m=y(I.id),c=y(o.id);if(m&&c&&m===c){const u=m,v=l[u].findIndex(w=>n(w)===I.id),E=l[u].findIndex(w=>n(w)===o.id);v!==E&&s({...l,[u]:de(l[u],v,E)})}},[b,l,y,n,j,s,d]),A=C.useMemo(()=>({columns:l,setColumns:s,getItemId:n,columnIds:b,activeId:h,setActiveId:g,findContainer:y,isColumn:j}),[l,s,n,b,h,y,j]);return e.jsx(M.Provider,{value:A,children:e.jsx(ot,{sensors:f,onDragStart:p,onDragOver:x,onDragEnd:S,children:e.jsx("div",{"data-slot":"kanban","data-dragging":h!==null,className:$(r),children:a})})})}function At({children:t,className:i}){const{columnIds:n}=C.useContext(M);return e.jsx(ve,{items:n,strategy:it,children:e.jsx("div",{"data-slot":"kanban-board",className:$("grid auto-rows-fr sm:grid-cols-4 gap-4",i),children:t})})}function Nt({value:t,className:i,children:n,disabled:a}){const{setNodeRef:r,transform:d,transition:l,attributes:s,listeners:h,isDragging:g}=be({id:t,disabled:a}),{activeId:f,isColumn:b}=C.useContext(M),j=f?b(f):!1,y={transition:l,transform:ye.Translate.toString(d)};return e.jsx(Dt.Provider,{value:{attributes:s,listeners:h,isDragging:j,disabled:a},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":g,"data-disabled":a,ref:r,style:y,className:$("group/kanban-column flex flex-col",g&&"opacity-50",a&&"opacity-50",i),children:n})})}function Ot({value:t,asChild:i=!1,className:n,children:a,disabled:r}){const{setNodeRef:d,transform:l,transition:s,attributes:h,listeners:g,isDragging:f}=be({id:t,disabled:r}),{activeId:b,isColumn:j}=C.useContext(M),y=b?!j(b):!1,p={transition:s,transform:ye.Translate.toString(l)},x=i?q:"div";return e.jsx(De.Provider,{value:{listeners:g,isDragging:y,disabled:r},children:e.jsx(x,{"data-slot":"kanban-item","data-value":t,"data-dragging":f,"data-disabled":r,ref:d,style:p,...h,className:$(f&&"opacity-50",r&&"opacity-50",n),children:a})})}function Lt({asChild:t,className:i,children:n,cursor:a=!0}){const[,r]=R(Ae),{listeners:d,isDragging:l,disabled:s}=C.useContext(De);C.useEffect(()=>{r(l)},[l]);const h=t?q:"div";return e.jsx(h,{"data-slot":"kanban-item-handle","data-dragging":l,"data-disabled":s,...d,className:$(a&&(l?"!cursor-grabbing":"!cursor-grab"),i),children:n})}function $t({value:t,className:i,children:n}){const{columns:a,getItemId:r}=C.useContext(M),d=C.useMemo(()=>a[t].map(r),[a,r,t]);return e.jsx(ve,{items:d,strategy:mt,children:e.jsx("div",{"data-slot":"kanban-column-content",className:$("flex flex-col gap-2",i),children:n})})}function Ft({children:t,className:i}){const{activeId:n,isColumn:a}=C.useContext(M),[r,d]=C.useState(null);C.useEffect(()=>{if(n){const h=document.querySelector(`[data-slot="kanban-${a(n)?"column":"item"}"][data-value="${n}"]`);if(h){const g=h.getBoundingClientRect();d({width:g.width,height:g.height})}}else d(null)},[n]);const l={width:r==null?void 0:r.width,height:r==null?void 0:r.height},s=C.useMemo(()=>n?typeof t=="function"?t({value:n,variant:a(n)?"column":"item"}):t:null,[n,t,a]);return e.jsx(at,{dropAnimation:It,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:l,className:$("pointer-events-none",i,n?"!cursor-grabbing":""),children:s})})}const Pt="",Tt={apiurl:Pt},{apiurl:Rt}=Tt;function te({cmd:t,cmd_url:i=null,method:n="GET",type:a="json",data:r={},header:d={},fileList:l=[],fileObj:s={}}){var f,b;n=n.toUpperCase(),a=a.toLowerCase();let h=i??`${Rt}/${t}`,g={method:n,headers:{"Content-Type":"application/json",...d}};if(l.length||((f=Object.keys(s))==null?void 0:f.length)>0){let j=new FormData;g.headers["Content-Type"]="multipart/form-data",[...l].forEach(p=>{j.append("files",p)}),(b=Object.keys(s))==null||b.map(p=>{Array.isArray(s[p])?[...s[p]].forEach(S=>{j.append(p,S)}):j.append(p,s[p])}),Object.keys(r).map(p=>{j.append(p,r[p])}),r=j}switch(n){case"POST":case"PUT":case"DELETE":g.data=r;break;case"GET":g.params=r;break}return ht({method:n,url:h,...g,withCredentials:!1}).then(j=>({ok:j.status=="200"||j.status=="403",status:j.status,body:j.data})).catch(j=>{let y=j.response;if(y)return{ok:y.status=="200",status:y.status,body:y.data};throw new Error({ok:!1,status:404,body:j.message})})}const Ut=async()=>await te({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Bt=async()=>await te({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Mt=async({list:t=[]})=>await te({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),pe={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},Ie=z(_((t,i)=>({...pe,setAlert:n=>t({...pe,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Kt=t=>t.map(i=>({id:i[0],title:i[1],jiraId:i[2],des:i[3],task:i[4],priority:i[5],assignee:i[6]})),ne=Q({open:!1});function Wt(){var r,d;const t=le({queryKey:["getGoogleSheetIssue"],queryFn:()=>Ut()}),i=le({queryKey:["getGoogleSheetTask"],queryFn:()=>Bt()}),n=Kt(((r=t==null?void 0:t.data)==null?void 0:r.values)||[]),a=((d=i==null?void 0:i.data)==null?void 0:d.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(zt,{tasks:a,issues:n,reLoadIssue:t.refetch})})}function Ee({task:t,asHandle:i,...n}){const[,a]=R(ne),r=localStorage.getItem("jiraLink"),d=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>a({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(F,{title:t.title,placement:"top",children:e.jsx("span",{className:"line-clamp-2 font-medium text-sm",children:t.title})}),e.jsx(Se,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsx("div",{className:"flex items-center text-muted-foreground text-xs",children:(t==null?void 0:t.des)||""}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("a",{target:"_blank",href:`${r}${t.jiraId}`,onClick:l=>l.stopPropagation(),children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(Ot,{value:t.id,...n,children:i?e.jsx(Lt,{children:d}):d})}function he({value:t,tasks:i,isOverlay:n,...a}){return e.jsxs(Nt,{value:t,...a,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(Se,{variant:"secondary",children:i.length})]})}),e.jsx($t,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:i.map(r=>e.jsx(Ee,{task:r,asHandle:!n},r.id))})]})}const Ae=Q(!1);function zt({tasks:t,issues:i,reLoadIssue:n}){const[a,r]=V.useState({}),[d,l]=V.useState(!1),[s]=R(Ae),[h,g]=R(ne),f=Ze({mutationFn:Mt});C.useEffect(()=>{if(Array.isArray(i)&&Array.isArray(t)){let p={};t==null||t.map(x=>{let S=x[0];p[S]=i==null?void 0:i.filter(A=>A.task==S)}),r(p)}},[i,t]),C.useEffect(()=>{var p;if(d){console.log("handle change google sheet"),l(!1);let x=[];(p=Object.keys(a))==null||p.map(S=>{let A=a[S].map(D=>[D.id,D.title,D.jiraId,D.des,S,D.priority,D.assignee]);x=x.concat(A)}),f.mutate({list:x},{onSuccess:S=>U.success("success")})}},[s]);const b=p=>{l(!0),r(p)},j=(p,x)=>{var S,A,D,I;if(p!=null&&p.id){let o=JSON.parse(JSON.stringify(a));(S=Object.keys(a))==null||S.map(c=>{o[c]=o[c].map(u=>(u==null?void 0:u.id)==(p==null?void 0:p.id)?{...u,...p}:u)});let m=[];(A=Object.keys(o))==null||A.map(c=>{let u=o[c].map(v=>[v.id,v.title,v.jiraId,v.des,c,v.priority,v!=null&&v.newAssignee?localStorage.getItem("user"):v.assignee]);m=m.concat(u)}),f.mutate({list:m},{onSuccess:()=>(r(o),x==null||x(!0),n(),U.success("success")),onError:()=>x==null?void 0:x(!1)})}else{let o=JSON.parse(JSON.stringify(a));const m=crypto.randomUUID().split("-")[0],c=(D=t==null?void 0:t[0])==null?void 0:D[0];o[c]=o[c].concat([{...p,id:m}]);let u=[];(I=Object.keys(o))==null||I.map(v=>{let E=o[v].map(w=>[w.id,w.title,w.jiraId,w.des,v,w.priority,w!=null&&w.newAssignee?localStorage.getItem("user"):w.assignee]);u=u.concat(E)}),f.mutate({list:u},{onSuccess:()=>(r(o),x==null||x(!0),n(),U.success("success")),onError:()=>x==null?void 0:x(!1)})}},y=(p,x)=>{var D,I;let S=JSON.parse(JSON.stringify(a));(D=Object.keys(a))==null||D.map(o=>{S[o]=S[o].filter(m=>(m==null?void 0:m.id)!=p)});let A=[];(I=Object.keys(S))==null||I.map(o=>{let m=S[o].map(c=>[c.id,c.title,c.jiraId,c.des,o,c.priority,c.assignee]);A=A.concat(m)}),f.mutate({list:A},{onSuccess:()=>(r(S),x==null||x(!0),U.success("success")),onError:()=>x==null?void 0:x(!1)})};return e.jsxs(e.Fragment,{children:[e.jsxs(Et,{value:a,onValueChange:b,getItemValue:p=>p.id,children:[e.jsx(At,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(a).map(([p,x])=>e.jsx(he,{value:p,tasks:x},p))}),e.jsx(Ft,{children:({value:p,variant:x})=>{if(x==="column"){const A=a[p]||[];return e.jsx(he,{value:p,tasks:A,isOverlay:!0})}const S=Object.values(a).flat().find(A=>A.id===p);return S?e.jsx(Ee,{task:S}):null}})]}),!!h.open&&e.jsx(Z,{open:h.open,onClose:(p,x)=>{x!=="backdropClick"&&g({open:!1})},fullWidth:!0,maxWidth:"lg",children:e.jsx(_t,{task:h.task,onClose:()=>g({open:!1}),onOk:j,onDel:y})})]})}const _t=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"high",assignee:""},onClose:i,onOk:n,onDel:a})=>{const[r,d]=C.useState(t),[l,s]=C.useState(!1),{setAlert:h}=Ie(),g=f=>{s(!1),f&&(i==null||i())};return e.jsxs(e.Fragment,{children:[e.jsx(X,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(k,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(B,{label:"Title",variant:"standard",value:(r==null?void 0:r.title)||"",disabled:l,onChange:f=>d(b=>({...b,title:f.target.value})),fullWidth:!0,autoFocus:!0}),e.jsx(B,{label:"jiraId",variant:"standard",defaultValue:(r==null?void 0:r.jiraId)||"",onChange:f=>d(b=>({...b,jiraId:f.target.value})),disabled:l,fullWidth:!0}),e.jsx(B,{label:"Des",variant:"standard",defaultValue:(r==null?void 0:r.des)||"",onChange:f=>d(b=>({...b,des:f.target.value})),disabled:l,fullWidth:!0}),e.jsx("div",{children:e.jsx(xt,{onChange:f=>{d(b=>({...b,newAssignee:f.target.checked}))},disabled:l,children:"Assign to me"})})]}),e.jsx(Y,{children:e.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[e.jsx("div",{children:(t==null?void 0:t.id)&&e.jsx(T,{onClick:()=>h({title:"刪除",content:"確定要刪除？",handleAgree:f=>(f==null||f(),s(!0),a(t==null?void 0:t.id,g))}),variant:"contained",color:"error",sx:{p:"8px 16px",fontWeight:"500",lineHeight:"1.25rem",fontSize:"0.875rem",textTransform:"none"},disabled:l,children:"Delete"})}),e.jsxs("div",{children:[e.jsx(me,{onClick:i,variant:"outlined",disabled:l,children:"Cancel"}),e.jsx(me,{onClick:()=>(s(!0),n(r,g)),disabled:l,children:"OK"})]})]})})]})},Gt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};z(_((t,i)=>({...Gt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const Jt={isSidebarOpen:!0},Ne=z(_((t,i)=>({...Jt,setSidebarOpen:(n=null)=>t(a=>({isSidebarOpen:n!==null?n:!a.isSidebarOpen}))}))),xe={open:!1,title:"",content:null,actions:null,body:null},Oe=z(_((t,i)=>({...xe,setDialog:n=>t({...xe,...n,open:!0}),closeDialog:()=>t({open:!1})})));function Ht(t){const{title:i,name:n,logout:a}=t,{setSidebarOpen:r}=Ne(),{setDialog:d}=Oe();ft();const[,l]=R(ne);return e.jsx(P,{sx:{flexGrow:1},children:e.jsx(Ue,{position:"fixed",sx:{zIndex:s=>s.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Be,{children:[e.jsx(L,{variant:"h6",component:"div",children:i}),e.jsx(P,{sx:{flexGrow:1}}),e.jsx(W,{style:{color:"white"},onClick:()=>d({title:"Settings",open:!0,content:e.jsx(kt,{})}),children:e.jsx(Me,{})}),e.jsx(W,{style:{color:"white"},onClick:()=>l({open:!0}),children:e.jsx(Ke,{})})]})})})}const kt=()=>e.jsxs(k,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(B,{label:"Sheet API",variant:"standard",defaultValue:localStorage.getItem("sheet")||"",onChange:t=>localStorage.setItem("sheet",t.target.value),fullWidth:!0,autoFocus:!0}),e.jsx(B,{label:"User Key",variant:"standard",defaultValue:localStorage.getItem("user")||"",onChange:t=>localStorage.setItem("user",t.target.value),fullWidth:!0}),e.jsx(B,{label:"Jira Link",variant:"standard",defaultValue:localStorage.getItem("jiraLink")||"",onChange:t=>localStorage.setItem("jiraLink",t.target.value),fullWidth:!0})]}),N={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},qt=Q(!1);function Qt({roomId:t,isHost:i}){const[n,a]=C.useState(null),[r,d]=R(qt),l=C.useRef(null),[s,h]=C.useState([]),[g,f]=C.useState([]),b=C.useRef({}),{setSnackMsg:j}=ee();C.useEffect(()=>{let o;if(t)return i?(o=new ue(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(o=new ue(void 0),console.log("Joiner attempting to open Peer with a random ID")),a(o),()=>{o&&!(o!=null&&o.destroyed)&&(console.log("Destroying peer instance:",o.id),o.destroy()),a(null),h([]),f([])}},[t,i]),C.useEffect(()=>{if(!n)return;n.removeAllListeners();const o=c=>console.error("PeerJS error:",c);n.on("error",o);const m=c=>{l.current=c,c.on("open",()=>{d(!0),console.log(`DataConnection open with ${c.peer}`)}),c.on("close",()=>{d(!1),l.current=null,console.log(`DataConnection closed with ${c.peer}`)}),c.on("error",u=>{console.error(`DataConnection error with ${c.peer}:`,u),d(!1)}),c.on("data",u=>{if(i)u.type==="file-received-ack"?(console.log(`Host: ACK for file ${u.fileId}`),h(v=>v.map(E=>E.id===u.fileId?{...E,status:N.SENT}:E))):u.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${u.fileId}: ${u.error}`),h(v=>v.map(E=>E.id===u.fileId?{...E,status:N.FAILED}:E)));else if(console.log("blob in",u),u.type==="file-metadata")console.log("Joiner: Received file metadata",u),b.current[u.fileId]=u;else if(u instanceof Blob||u instanceof ArrayBuffer||u instanceof Uint8Array){let v=null;const E=Object.keys(b.current).filter(w=>!g.some(O=>O.id===w));if(E.length>0){const w=E[E.length-1];w&&b.current[w]&&(v=b.current[w])}if(v){const{fileId:w,name:O,mimeType:G,size:K}=v;console.log(`Joiner: Received blob for ${O} (ID: ${w})`);const se=u instanceof Blob?u:new Blob([u],{type:G}),Le=URL.createObjectURL(se);f($e=>[...$e,{id:w,name:O,type:G,size:K,blobUrl:Le,blobObject:se,status:N.RECEIVED}]),c.send({type:"file-received-ack",fileId:w}),delete b.current[w]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else u.type==="batch-meta"&&console.log("Joiner: Received batch metadata",u)})};i?(n.on("open",c=>console.log(`Host Peer opened: ${c}`)),n.on("connection",m)):n.on("open",c=>{if(console.log(`Joiner Peer opened: ${c}`),t){const u=n.connect(t);m(u)}})},[n,t,i,g]);const y=o=>{const m=Array.from(o.target.files).map(c=>({id:bt(),name:c.name,size:c.size,type:c.type,previewUrl:URL.createObjectURL(c),status:N.SELECTED,fileObject:c}));h(c=>[...c,...m]),o.target.value=null},p=async()=>{if(!r||!l.current){alert("連線未建立!");return}const o=s.filter(m=>m.status===N.SELECTED);if(o.length===0){alert("沒有已選擇的檔案可傳送。");return}l.current.send({type:"batch-meta",totalFiles:o.length});for(const m of o){h(c=>c.map(u=>u.id===m.id?{...u,status:N.SENDING}:u));try{const c={type:"file-metadata",fileId:m.id,name:m.name,mimeType:m.type,size:m.size};l.current.send(c)}catch(c){console.error(`Host: Error sending file ${m.name}:`,c),h(u=>u.map(v=>v.id===m.id?{...v,status:N.FAILED}:v))}}for(const m of o)try{await new Promise(c=>setTimeout(c,50)),l.current.send(m.fileObject),console.log(`Host: Sent ${m.name} (ID: ${m.id})`)}catch(c){console.error(`Host: Error sending file ${m.name}:`,c),h(u=>u.map(v=>v.id===m.id?{...v,status:N.FAILED}:v))}},x=o=>{const m=g.find(c=>c.id===o);if(m){const c=document.createElement("a");c.href=m.blobUrl,c.download=m.name,document.body.appendChild(c),c.click(),document.body.removeChild(c),f(u=>u.map(v=>v.id===o?{...v,status:N.DOWNLOADED}:v))}},S=async()=>{const o=g.filter(m=>m.status===N.RECEIVED&&m.blobUrl);if(o.length===0){j({message:"沒有可下載的新檔案。"});return}for(let m=0;m<o.length;m++){const c=o[m];console.log(`Auto-downloading ${m+1}/${o.length}: ${c.name}`),x(c.id),m<o.length-1&&await new Promise(u=>setTimeout(u,500))}j({message:`${o.length} 個檔案已開始下載。`})},A=g.some(o=>o.status===N.RECEIVED&&o.blobUrl),D=o=>{const m=s.filter(c=>c.id!==o);h(m)},I=(o,m=null)=>{switch(o){case N.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"已選擇",children:e.jsx(He,{color:"action"})}),e.jsx(F,{title:"刪除",children:e.jsx(W,{sx:{ml:1},onClick:()=>D(m),children:e.jsx(ke,{color:"action"})})})]});case N.SENDING:return e.jsx(F,{title:"傳送中",children:e.jsx(Je,{color:"primary",className:"animate-spin"})});case N.SENT:return e.jsx(F,{title:"已傳送",children:e.jsx(ae,{color:"success"})});case N.FAILED:return e.jsx(F,{title:"失敗",children:e.jsx(Ge,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(Ce,{children:e.jsx(we,{path:"/transfer",element:e.jsxs(We,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs(L,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",i?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs(L,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),i&&e.jsxs(L,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs(L,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${r?"bg-green-500":"bg-red-500"}`,children:r?"已連線":"未連線"})]})]}),i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx(L,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(T,{variant:"outlined",component:"label",disabled:!r,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:y})]}),e.jsx(T,{variant:"contained",color:"primary",onClick:p,disabled:!r||!s.some(o=>o.status===N.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(re,{dense:!0,children:s.map(o=>e.jsxs(oe,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.previewUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(ie,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB - 狀態: ${o.status}`}),e.jsx("div",{className:"ml-auto",children:I(o.status,o.id)})]},o.id))})]}),!i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs(L,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),g.length>0&&e.jsx(T,{variant:"contained",size:"small",startIcon:e.jsx(ze,{}),onClick:S,disabled:!A||!r,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),g.length===0&&r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),g.length===0&&!r&&e.jsx(L,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),g.length>0&&e.jsx(re,{dense:!0,children:g.map(o=>e.jsxs(oe,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.blobUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(ie,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB`}),e.jsx(F,{title:"下載檔案",children:e.jsx(W,{color:"primary",onClick:()=>x(o.id),disabled:o.status===N.DOWNLOADED,children:e.jsx(_e,{})})}),o.status===N.DOWNLOADED&&e.jsx(F,{title:"已下載",children:e.jsx(ae,{color:"success",className:"ml-2"})})]},o.id))})]})]})})})})}function Vt(){const[t,i]=jt(),n=t.get("roomId"),a=t.get("isHost");return e.jsxs(P,{sx:{flex:"1 1 auto"},children:[e.jsx(Qt,{roomId:n,isHost:a}),e.jsx(Ce,{children:e.jsx(we,{path:"/",element:e.jsx(Wt,{})})})]})}function Zt(t){const{title:i}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function Xt(){return J("(min-width:900px)"),e.jsx(P,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(P,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(Vt,{}),e.jsx(Zt,{title:null})]})})}function Yt(){const{open:t,closeAlert:i,title:n,content:a,handleAgree:r,handleDisagree:d}=Ie(l=>l);return e.jsxs(Z,{open:t,onClose:i,children:[e.jsx(X,{children:n}),e.jsx(k,{children:e.jsx(qe,{sx:{whiteSpace:"pre-line"},children:a})}),e.jsxs(Y,{children:[e.jsx(T,{onClick:i,children:"取消"}),e.jsx(T,{onClick:()=>r(i),autoFocus:!0,children:"確認"})]})]})}function en(t){var x;const{children:i,margin:n=15,sx:a={},content_sx:r={},data:d=null,onlyProps:l=!1,noDrawer:s=!1}=t,h=((x=Ne())==null?void 0:x.isDrawerOpen)&&!s,g=J(h?"(min-width:1440px)":"(min-width:1200px)"),f=J(h?"(min-width:1232px)":"(min-width:992px)"),b=J(h?"(min-width:1008px)":"(min-width:768px)");let j=g?"1170px":f?"970px":b?"750px":"100%",y=(d==null?void 0:d.length)<3?`${100/d.length}%`:g?1170/3:f?970/3:b?750/2:j;const p={content_width:j,margin:`${n}px`,width:y,width_margin:typeof y!="string"?y-n*2:`calc(${y} - ${n*2}px)`,lg:g,md:f,xs:b};return l==!0?e.jsx(C.Fragment,{children:C.cloneElement(i,{...p})}):e.jsx(P,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...a},children:e.jsx(P,{sx:{width:j,display:"flex",flexWrap:"wrap",...r},children:C.cloneElement(i,{...p})})})}const tn=Qe(Z)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function nn(t){const{isRwdWidth:i}=t;return i?e.jsx(en,{onlyProps:!0,noDrawer:!0,children:e.jsx(fe,{...t})}):e.jsx(fe,{...t})}const fe=t=>{const{content_width:i,open:n,title:a,content:r,actions:d,body:l,closeDialog:s,disableScrollLock:h,fullWidth:g,fullHeight:f,maxWidth:b,fullScreen:j,isRwdWidth:y,contentProps:p={}}=t,x=y?{sx:{width:"100%",maxWidth:`${i} !important`,height:f?"100%":"auto"}}:{fullWidth:g,maxWidth:b,fullScreen:j};return e.jsxs(tn,{onClose:s,open:n,disableScrollLock:!!h,...y?{}:x,PaperProps:{...y?x:{}},children:[e.jsxs(P,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(X,{sx:{m:0,p:0,pl:1},children:a}),e.jsx(W,{onClick:s,sx:{color:S=>S.palette.grey[500]},children:e.jsx(Ve,{})})]}),l?C.cloneElement(l,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(k,{dividers:!0,sx:{...p},children:!!r&&C.cloneElement(r,{closeDialog:s})}),!!d&&e.jsx(Y,{children:C.cloneElement(d,{closeDialog:s})})]})]})},sn=()=>{const{...t}=Oe();return e.jsxs(e.Fragment,{children:[e.jsx(Ht,{title:"SAF Kanban"}),e.jsx(Xt,{}),e.jsx(Yt,{}),e.jsx(Ct,{}),e.jsx(nn,{...t})]})},rn={},H=Q(rn,async(t,i,n)=>{let a=t(H);i(H,{...a,...n})}),on=()=>{const[{...t},i]=R(H),n=({key:a,body:r})=>{console.log(`apiDataAtom log (${a}):`,{...t,[a]:r}),i({[a]:r})};return{...pt(H),setApiData:n}},an=()=>{const{setSnackMsg:t}=ee(s=>s),{setApiData:i}=on(),n=(s=[])=>{let h="";s==null||s.map((g,f)=>{h+=(f==0?"":`

`)+((g==null?void 0:g.displayName)||(g==null?void 0:g.field))+`：
`+(g==null?void 0:g.error)}),setAlert({title:"錯誤",content:h,handleAgree:g=>g()})},a=(s,h,g)=>{console.log("onError",s,h),U.error("API發生未知錯誤")},r=async(s,h)=>{var f,b,j,y,p,x,S,A,D,I,o;((b=(f=h==null?void 0:h.queryKey)==null?void 0:f[0])==null?void 0:b[0])=="_"&&i({key:(y=(j=h==null?void 0:h.queryKey)==null?void 0:j[0])==null?void 0:y.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(p=h==null?void 0:h.options)==null?void 0:p.queryFn}});const g=((x=s==null?void 0:s.body)==null?void 0:x.status)!==null&&((S=s==null?void 0:s.body)==null?void 0:S.status)!==void 0?(A=s==null?void 0:s.body)==null?void 0:A.status:null;g!==null&&Array.isArray((D=s==null?void 0:s.body)==null?void 0:D.errorArray)?n((I=s==null?void 0:s.body)==null?void 0:I.errorArray):g!==null&&t({message:(o=s==null?void 0:s.body)==null?void 0:o.message}),!(s!=null&&s.ok)&&g==null&&!(s!=null&&s.pages)&&U.error("API發生未知錯誤！")},d=(s,h)=>{},l=new Xe({queryCache:new et({onSuccess:r,onError:a,onSettled:d}),mutationCache:new Ye({onSuccess:r,onError:a}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var f,b,j,y;let g=(((f=s==null?void 0:s.body)==null?void 0:f.status)!==null&&((b=s==null?void 0:s.body)==null?void 0:b.status)!==void 0?(j=s==null?void 0:s.body)==null?void 0:j.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let p=[];(y=s==null?void 0:s.pages)==null||y.map((x,S)=>{p[S]=(x==null?void 0:x.body)||x}),g={...s,pages:p}}return g}}}});return e.jsx(tt,{client:l,children:e.jsx(vt,{basename:"/SAF_Kanban/",children:e.jsx(sn,{})})})},ln=document.getElementById("root");Fe.createRoot(ln).render(e.jsx(an,{}));
