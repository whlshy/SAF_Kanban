import{j as e,R as Q,r as j}from"./react-BkCFb41Y.js";import{a as $e}from"./react-dom-BcT_u2RR.js";import{c as M}from"./zustand-DLhad_yI.js";import{B as F,S as Le,a as Pe,b as Te,D as Z,c as V,d as X,T as q,e as Y,f as P,A as Fe,g as Re,h as $,I as G,i as Ue,P as Be,L as se,j as re,k as oe,l as Me,m as T,C as Ke,n as ie,E as ze,H as We,o as Ge,p as _e,u as W,q as ke,s as Je,r as He}from"./@mui-xlN6yUIm.js";import{u as ae,a as qe,Q as Qe,M as Ze,b as Ve,c as Xe}from"./@tanstack-DpQXpXmE.js";import{S as k}from"./@radix-ui-B08lzGHt.js";import{c as fe}from"./class-variance-authority-Dp3B9jqt.js";import{c as Ye}from"./clsx-B-dksMZM.js";import{t as et}from"./tailwind-merge-BZSatpsL.js";import{u as tt,a as le,b as ce,D as nt,S as ve,r as st,c as rt,d as ot,e as it,s as at,K as lt,P as ct,f as be,C as je,v as dt}from"./@dnd-kit-Le8HzPvy.js";import{u as R,a as J,b as ut}from"./jotai-B-Mb4bjH.js";import{a as mt}from"./axios-Dnk_-Q5K.js";import{u as gt,b as ye,c as Ce}from"./react-router-COu1yu9k.js";import{u as pt,B as xt}from"./react-router-dom-BpY5ankm.js";import"./react-qr-code-Bf0iBglm.js";import{$ as de}from"./peerjs-DxFR7Coi.js";import{v as ht}from"./uuid-C6aID195.js";import"./@babel-B_fy3T9z.js";import"./scheduler-C323NY8X.js";import"./react-is-BwqtTtay.js";import"./react-transition-group-CEW9j9Fk.js";import"./@emotion-B9jP_P4v.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-DzGuYBkV.js";import"./sdp-C8-99_ry.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const d of u.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&l(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function l(r){if(r.ep)return;r.ep=!0;const u=n(r);fetch(r.href,u)}})();const K=t=>(i,n,l)=>t((...r)=>{console.log("  applying",r),i(...r),console.log("  new state",n())},n,l),ue={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},H=M(K((t,i)=>({...ue,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(ue)})));function ft(t){return e.jsx(Te,{...t,direction:"down"})}function vt(t){const{snackbar:i,closeSnackbar:n,message:l,open:r,anchorOrigin:u,autoHideDuration:d,status:s}=H(y=>y),g=e.jsx(Q.Fragment,{children:e.jsx(F,{color:"inherit",size:"small",onClick:n,children:"確認"})}),p=y=>{switch(y){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx(Le,{open:r,onClose:n,anchorOrigin:u,TransitionComponent:ft,autoHideDuration:d,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(Pe,{message:s!=null?p(s):l,action:g})})})})}function L(...t){return et(Ye(t))}const bt=fe("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function we({className:t,variant:i,asChild:n=!1,...l}){const r=n?k:"span";return e.jsx(r,{"data-slot":"badge",className:L(bt({variant:i}),t),...l})}const jt=fe("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function me({className:t,variant:i,size:n,asChild:l=!1,...r}){const u=l?k:"button";return e.jsx(u,{"data-slot":"button",className:L(jt({variant:i,size:n,className:t})),...r})}const U=j.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),yt=j.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),De=j.createContext({listeners:void 0,isDragging:!1,disabled:!1}),Ct={...it,sideEffects:ot({styles:{active:{opacity:"0.4"}}})};function wt({value:t,onValueChange:i,getItemValue:n,children:l,className:r,onMove:u}){const d=t,s=i,[g,p]=j.useState(null),y=tt(le(ct,{activationConstraint:{distance:10}}),le(lt,{coordinateGetter:at})),C=j.useMemo(()=>Object.keys(d),[d]),h=j.useCallback(D=>C.includes(D),[C]),b=j.useCallback(D=>h(D)?D:C.find(I=>d[I].some(o=>n(o)===D)),[d,C,n,h]),x=j.useCallback(D=>{p(D.active.id)},[]),v=j.useCallback(D=>{if(u)return;const{active:I,over:o}=D;if(!o||h(I.id))return;const m=b(I.id),a=b(o.id);if(!m||!a||m===a)return;const c=d[m],f=d[a],E=c.findIndex(B=>n(B)===I.id);let S=f.findIndex(B=>n(B)===o.id);h(o.id)&&(S=f.length);const O=[...f],[z]=c.splice(E,1);O.splice(S,0,z),s({...d,[m]:[...c],[a]:O})},[b,n,h,s,d,u]),w=j.useCallback(D=>{const{active:I,over:o}=D;if(p(null),!o)return;if(u&&!h(I.id)){const c=b(I.id),f=b(o.id);if(c&&f){const E=d[c].findIndex(O=>n(O)===I.id),S=h(o.id)?d[f].length:d[f].findIndex(O=>n(O)===o.id);u({event:D,activeContainer:c,activeIndex:E,overContainer:f,overIndex:S})}return}if(h(I.id)&&h(o.id)){const c=C.indexOf(I.id),f=C.indexOf(o.id);if(c!==f){const E=ce(Object.keys(d),c,f),S={};E.forEach(O=>{S[O]=d[O]}),s(S)}return}const m=b(I.id),a=b(o.id);if(m&&a&&m===a){const c=m,f=d[c].findIndex(S=>n(S)===I.id),E=d[c].findIndex(S=>n(S)===o.id);f!==E&&s({...d,[c]:ce(d[c],f,E)})}},[C,d,b,n,h,s,u]),A=j.useMemo(()=>({columns:d,setColumns:s,getItemId:n,columnIds:C,activeId:g,setActiveId:p,findContainer:b,isColumn:h}),[d,s,n,C,g,b,h]);return e.jsx(U.Provider,{value:A,children:e.jsx(nt,{sensors:y,onDragStart:x,onDragOver:v,onDragEnd:w,children:e.jsx("div",{"data-slot":"kanban","data-dragging":g!==null,className:L(r),children:l})})})}function Dt({children:t,className:i}){const{columnIds:n}=j.useContext(U);return e.jsx(ve,{items:n,strategy:st,children:e.jsx("div",{"data-slot":"kanban-board",className:L("grid auto-rows-fr sm:grid-cols-4 gap-4",i),children:t})})}function St({value:t,className:i,children:n,disabled:l}){const{setNodeRef:r,transform:u,transition:d,attributes:s,listeners:g,isDragging:p}=be({id:t,disabled:l}),{activeId:y,isColumn:C}=j.useContext(U),h=y?C(y):!1,b={transition:d,transform:je.Translate.toString(u)};return e.jsx(yt.Provider,{value:{attributes:s,listeners:g,isDragging:h,disabled:l},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":p,"data-disabled":l,ref:r,style:b,className:L("group/kanban-column flex flex-col",p&&"opacity-50",l&&"opacity-50",i),children:n})})}function It({value:t,asChild:i=!1,className:n,children:l,disabled:r}){const{setNodeRef:u,transform:d,transition:s,attributes:g,listeners:p,isDragging:y}=be({id:t,disabled:r}),{activeId:C,isColumn:h}=j.useContext(U),b=C?!h(C):!1,x={transition:s,transform:je.Translate.toString(d)},v=i?k:"div";return e.jsx(De.Provider,{value:{listeners:p,isDragging:b,disabled:r},children:e.jsx(v,{"data-slot":"kanban-item","data-value":t,"data-dragging":y,"data-disabled":r,ref:u,style:x,...g,className:L(y&&"opacity-50",r&&"opacity-50",n),children:l})})}function Et({asChild:t,className:i,children:n,cursor:l=!0}){const[,r]=R(Ee),{listeners:u,isDragging:d,disabled:s}=j.useContext(De);j.useEffect(()=>{r(d)},[d]);const g=t?k:"div";return e.jsx(g,{"data-slot":"kanban-item-handle","data-dragging":d,"data-disabled":s,...u,className:L(l&&(d?"!cursor-grabbing":"!cursor-grab"),i),children:n})}function At({value:t,className:i,children:n}){const{columns:l,getItemId:r}=j.useContext(U),u=j.useMemo(()=>l[t].map(r),[l,r,t]);return e.jsx(ve,{items:u,strategy:dt,children:e.jsx("div",{"data-slot":"kanban-column-content",className:L("flex flex-col gap-2",i),children:n})})}function Nt({children:t,className:i}){const{activeId:n,isColumn:l}=j.useContext(U),[r,u]=j.useState(null);j.useEffect(()=>{if(n){const g=document.querySelector(`[data-slot="kanban-${l(n)?"column":"item"}"][data-value="${n}"]`);if(g){const p=g.getBoundingClientRect();u({width:p.width,height:p.height})}}else u(null)},[n]);const d={width:r==null?void 0:r.width,height:r==null?void 0:r.height},s=j.useMemo(()=>n?typeof t=="function"?t({value:n,variant:l(n)?"column":"item"}):t:null,[n,t,l]);return e.jsx(rt,{dropAnimation:Ct,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:d,className:L("pointer-events-none",i,n?"!cursor-grabbing":""),children:s})})}const Ot="",$t={apiurl:Ot},{apiurl:Lt}=$t;function ee({cmd:t,cmd_url:i=null,method:n="GET",type:l="json",data:r={},header:u={},fileList:d=[],fileObj:s={}}){var y,C;n=n.toUpperCase(),l=l.toLowerCase();let g=i??`${Lt}/${t}`,p={method:n,headers:{"Content-Type":"application/json",...u}};if(d.length||((y=Object.keys(s))==null?void 0:y.length)>0){let h=new FormData;p.headers["Content-Type"]="multipart/form-data",[...d].forEach(x=>{h.append("files",x)}),(C=Object.keys(s))==null||C.map(x=>{Array.isArray(s[x])?[...s[x]].forEach(w=>{h.append(x,w)}):h.append(x,s[x])}),Object.keys(r).map(x=>{h.append(x,r[x])}),r=h}switch(n){case"POST":case"PUT":case"DELETE":p.data=r;break;case"GET":p.params=r;break}return mt({method:n,url:g,...p,withCredentials:!1}).then(h=>({ok:h.status=="200"||h.status=="403",status:h.status,body:h.data})).catch(h=>{let b=h.response;if(b)return{ok:b.status=="200",status:b.status,body:b.data};throw new Error({ok:!1,status:404,body:h.message})})}const Pt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Tt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Ft=async({list:t=[]})=>await ee({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),ge={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},Se=M(K((t,i)=>({...ge,setAlert:n=>t({...ge,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Rt=t=>t.map(i=>({id:i[0],title:i[1],jiraId:i[2],des:i[3],task:i[4],priority:i[5],assignee:i[6]})),te=J({open:!1});function Ut(){var r,u;const t=ae({queryKey:["getGoogleSheetIssue"],queryFn:()=>Pt()}),i=ae({queryKey:["getGoogleSheetTask"],queryFn:()=>Tt()}),n=Rt(((r=t==null?void 0:t.data)==null?void 0:r.values)||[]),l=((u=i==null?void 0:i.data)==null?void 0:u.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(Bt,{tasks:l,issues:n})})}function Ie({task:t,asHandle:i,...n}){const[,l]=R(te),r=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>l({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"line-clamp-1 font-medium text-sm",children:t.title}),e.jsx(we,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsx("div",{className:"flex items-center text-muted-foreground text-xs",children:(t==null?void 0:t.des)||""}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(It,{value:t.id,...n,children:i?e.jsx(Et,{children:r}):r})}function pe({value:t,tasks:i,isOverlay:n,...l}){return e.jsxs(St,{value:t,...l,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(we,{variant:"secondary",children:i.length})]})}),e.jsx(At,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:i.map(r=>e.jsx(Ie,{task:r,asHandle:!n},r.id))})]})}const Ee=J(!1);function Bt({tasks:t,issues:i}){const[n,l]=Q.useState({}),[r,u]=Q.useState(!1),[d]=R(Ee),[s,g]=R(te),{setSnackMsg:p}=H(x=>x),y=qe({mutationFn:Ft,onSuccess:()=>p({message:"success"})});j.useEffect(()=>{if(Array.isArray(i)&&Array.isArray(t)){let x={};t==null||t.map(v=>{let w=v[0];x[w]=i==null?void 0:i.filter(A=>A.task==w)}),l(x)}},[i,t]),j.useEffect(()=>{var x;if(r){console.log("handle change google sheet"),u(!1);let v=[];(x=Object.keys(n))==null||x.map(w=>{let A=n[w].map(D=>[D.id,D.title,D.jiraId,D.des,w,D.priority,D.assignee]);v=v.concat(A)}),y.mutate({list:v},{onSuccess:w=>console.log(w)})}},[d]);const C=x=>{u(!0),l(x)},h=(x,v)=>{var w,A,D,I;if(x!=null&&x.id){let o=JSON.parse(JSON.stringify(n));(w=Object.keys(n))==null||w.map(a=>{o[a]=o[a].map(c=>(c==null?void 0:c.id)==(x==null?void 0:x.id)?{...c,...x}:c)});let m=[];(A=Object.keys(o))==null||A.map(a=>{let c=o[a].map(f=>[f.id,f.title,f.jiraId,f.des,a,f.priority,f.assignee]);m=m.concat(c)}),y.mutate({list:m},{onSuccess:()=>(l(o),v==null?void 0:v())})}else{let o=JSON.parse(JSON.stringify(n));const m=crypto.randomUUID().split("-")[0],a=(D=t==null?void 0:t[0])==null?void 0:D[0];o[a]=o[a].concat([{...x,id:m}]);let c=[];(I=Object.keys(o))==null||I.map(f=>{let E=o[f].map(S=>[S.id,S.title,S.jiraId,S.des,f,S.priority,S.assignee]);c=c.concat(E)}),y.mutate({list:c},{onSuccess:()=>(l(o),v==null?void 0:v())})}},b=(x,v)=>{var D,I;let w=JSON.parse(JSON.stringify(n));(D=Object.keys(n))==null||D.map(o=>{w[o]=w[o].filter(m=>(m==null?void 0:m.id)!=x)});let A=[];(I=Object.keys(w))==null||I.map(o=>{let m=w[o].map(a=>[a.id,a.title,a.jiraId,a.des,o,a.priority,a.assignee]);A=A.concat(m)}),y.mutate({list:A},{onSuccess:()=>(l(w),v==null?void 0:v())})};return e.jsxs(e.Fragment,{children:[e.jsxs(wt,{value:n,onValueChange:C,getItemValue:x=>x.id,children:[e.jsx(Dt,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(n).map(([x,v])=>e.jsx(pe,{value:x,tasks:v},x))}),e.jsx(Nt,{children:({value:x,variant:v})=>{if(v==="column"){const A=n[x]||[];return e.jsx(pe,{value:x,tasks:A,isOverlay:!0})}const w=Object.values(n).flat().find(A=>A.id===x);return w?e.jsx(Ie,{task:w}):null}})]}),!!s.open&&e.jsx(Z,{open:s.open,onClose:()=>g({open:!1}),fullWidth:!0,maxWidth:"lg",children:e.jsx(Mt,{task:s.task,onClose:()=>g({open:!1}),onOk:h,onDel:b})})]})}const Mt=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"high",assignee:""},onClose:i,onOk:n,onDel:l})=>{const[r,u]=j.useState(t),{setAlert:d}=Se();return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(X,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(q,{label:"Title",variant:"standard",value:(r==null?void 0:r.title)||"",onChange:s=>u(g=>({...g,title:s.target.value})),fullWidth:!0}),e.jsx(q,{label:"jiraId",variant:"standard",defaultValue:(r==null?void 0:r.jiraId)||"",onChange:s=>u(g=>({...g,jiraId:s.target.value})),fullWidth:!0}),e.jsx(q,{label:"Des",variant:"standard",defaultValue:(r==null?void 0:r.des)||"",onChange:s=>u(g=>({...g,des:s.target.value})),fullWidth:!0})]}),e.jsx(Y,{children:e.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[e.jsx("div",{children:(t==null?void 0:t.id)&&e.jsx(F,{onClick:()=>d({title:"刪除",content:"確定要刪除？",handleAgree:s=>(s==null||s(),l(t==null?void 0:t.id,i))}),variant:"contained",color:"error",sx:{p:"8px 16px",fontWeight:"500",lineHeight:"1.25rem",fontSize:"0.875rem",textTransform:"none"},children:"Delete"})}),e.jsxs("div",{children:[e.jsx(me,{onClick:i,variant:"outlined",children:"Cancel"}),e.jsx(me,{onClick:()=>n(r,i),children:"OK"})]})]})})]})},Kt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};M(K((t,i)=>({...Kt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const zt={isSidebarOpen:!0},Ae=M(K((t,i)=>({...zt,setSidebarOpen:(n=null)=>t(l=>({isSidebarOpen:n!==null?n:!l.isSidebarOpen}))}))),xe={open:!1,title:"",content:null,actions:null,body:null},Wt=M(K((t,i)=>({...xe,setDialog:n=>t({...xe,...n,open:!0}),closeDialog:()=>t({open:!1})})));function Gt(t){const{title:i,name:n,logout:l}=t,{setSidebarOpen:r}=Ae();gt();const[,u]=R(te);return e.jsx(P,{sx:{flexGrow:1},children:e.jsx(Fe,{position:"fixed",sx:{zIndex:d=>d.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Re,{children:[e.jsx($,{variant:"h6",component:"div",children:i}),e.jsx(P,{sx:{flexGrow:1}}),e.jsx(G,{style:{color:"white"},onClick:()=>u({open:!0}),children:e.jsx(Ue,{})})]})})})}const N={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},_t=J(!1);function kt({roomId:t,isHost:i}){const[n,l]=j.useState(null),[r,u]=R(_t),d=j.useRef(null),[s,g]=j.useState([]),[p,y]=j.useState([]),C=j.useRef({}),{setSnackMsg:h}=H();j.useEffect(()=>{let o;if(t)return i?(o=new de(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(o=new de(void 0),console.log("Joiner attempting to open Peer with a random ID")),l(o),()=>{o&&!(o!=null&&o.destroyed)&&(console.log("Destroying peer instance:",o.id),o.destroy()),l(null),g([]),y([])}},[t,i]),j.useEffect(()=>{if(!n)return;n.removeAllListeners();const o=a=>console.error("PeerJS error:",a);n.on("error",o);const m=a=>{d.current=a,a.on("open",()=>{u(!0),console.log(`DataConnection open with ${a.peer}`)}),a.on("close",()=>{u(!1),d.current=null,console.log(`DataConnection closed with ${a.peer}`)}),a.on("error",c=>{console.error(`DataConnection error with ${a.peer}:`,c),u(!1)}),a.on("data",c=>{if(i)c.type==="file-received-ack"?(console.log(`Host: ACK for file ${c.fileId}`),g(f=>f.map(E=>E.id===c.fileId?{...E,status:N.SENT}:E))):c.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${c.fileId}: ${c.error}`),g(f=>f.map(E=>E.id===c.fileId?{...E,status:N.FAILED}:E)));else if(console.log("blob in",c),c.type==="file-metadata")console.log("Joiner: Received file metadata",c),C.current[c.fileId]=c;else if(c instanceof Blob||c instanceof ArrayBuffer||c instanceof Uint8Array){let f=null;const E=Object.keys(C.current).filter(S=>!p.some(O=>O.id===S));if(E.length>0){const S=E[E.length-1];S&&C.current[S]&&(f=C.current[S])}if(f){const{fileId:S,name:O,mimeType:z,size:B}=f;console.log(`Joiner: Received blob for ${O} (ID: ${S})`);const ne=c instanceof Blob?c:new Blob([c],{type:z}),Ne=URL.createObjectURL(ne);y(Oe=>[...Oe,{id:S,name:O,type:z,size:B,blobUrl:Ne,blobObject:ne,status:N.RECEIVED}]),a.send({type:"file-received-ack",fileId:S}),delete C.current[S]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else c.type==="batch-meta"&&console.log("Joiner: Received batch metadata",c)})};i?(n.on("open",a=>console.log(`Host Peer opened: ${a}`)),n.on("connection",m)):n.on("open",a=>{if(console.log(`Joiner Peer opened: ${a}`),t){const c=n.connect(t);m(c)}})},[n,t,i,p]);const b=o=>{const m=Array.from(o.target.files).map(a=>({id:ht(),name:a.name,size:a.size,type:a.type,previewUrl:URL.createObjectURL(a),status:N.SELECTED,fileObject:a}));g(a=>[...a,...m]),o.target.value=null},x=async()=>{if(!r||!d.current){alert("連線未建立!");return}const o=s.filter(m=>m.status===N.SELECTED);if(o.length===0){alert("沒有已選擇的檔案可傳送。");return}d.current.send({type:"batch-meta",totalFiles:o.length});for(const m of o){g(a=>a.map(c=>c.id===m.id?{...c,status:N.SENDING}:c));try{const a={type:"file-metadata",fileId:m.id,name:m.name,mimeType:m.type,size:m.size};d.current.send(a)}catch(a){console.error(`Host: Error sending file ${m.name}:`,a),g(c=>c.map(f=>f.id===m.id?{...f,status:N.FAILED}:f))}}for(const m of o)try{await new Promise(a=>setTimeout(a,50)),d.current.send(m.fileObject),console.log(`Host: Sent ${m.name} (ID: ${m.id})`)}catch(a){console.error(`Host: Error sending file ${m.name}:`,a),g(c=>c.map(f=>f.id===m.id?{...f,status:N.FAILED}:f))}},v=o=>{const m=p.find(a=>a.id===o);if(m){const a=document.createElement("a");a.href=m.blobUrl,a.download=m.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),y(c=>c.map(f=>f.id===o?{...f,status:N.DOWNLOADED}:f))}},w=async()=>{const o=p.filter(m=>m.status===N.RECEIVED&&m.blobUrl);if(o.length===0){h({message:"沒有可下載的新檔案。"});return}for(let m=0;m<o.length;m++){const a=o[m];console.log(`Auto-downloading ${m+1}/${o.length}: ${a.name}`),v(a.id),m<o.length-1&&await new Promise(c=>setTimeout(c,500))}h({message:`${o.length} 個檔案已開始下載。`})},A=p.some(o=>o.status===N.RECEIVED&&o.blobUrl),D=o=>{const m=s.filter(a=>a.id!==o);g(m)},I=(o,m=null)=>{switch(o){case N.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"已選擇",children:e.jsx(Ge,{color:"action"})}),e.jsx(T,{title:"刪除",children:e.jsx(G,{sx:{ml:1},onClick:()=>D(m),children:e.jsx(_e,{color:"action"})})})]});case N.SENDING:return e.jsx(T,{title:"傳送中",children:e.jsx(We,{color:"primary",className:"animate-spin"})});case N.SENT:return e.jsx(T,{title:"已傳送",children:e.jsx(ie,{color:"success"})});case N.FAILED:return e.jsx(T,{title:"失敗",children:e.jsx(ze,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(ye,{children:e.jsx(Ce,{path:"/transfer",element:e.jsxs(Be,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs($,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",i?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs($,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),i&&e.jsxs($,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs($,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${r?"bg-green-500":"bg-red-500"}`,children:r?"已連線":"未連線"})]})]}),i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx($,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(F,{variant:"outlined",component:"label",disabled:!r,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:b})]}),e.jsx(F,{variant:"contained",color:"primary",onClick:x,disabled:!r||!s.some(o=>o.status===N.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(se,{dense:!0,children:s.map(o=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.previewUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB - 狀態: ${o.status}`}),e.jsx("div",{className:"ml-auto",children:I(o.status,o.id)})]},o.id))})]}),!i&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs($,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),p.length>0&&e.jsx(F,{variant:"contained",size:"small",startIcon:e.jsx(Me,{}),onClick:w,disabled:!A||!r,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),p.length===0&&r&&e.jsx($,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),p.length===0&&!r&&e.jsx($,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),p.length>0&&e.jsx(se,{dense:!0,children:p.map(o=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:o.blobUrl,alt:o.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:o.name}),secondary:`${(o.size/1024).toFixed(1)} KB`}),e.jsx(T,{title:"下載檔案",children:e.jsx(G,{color:"primary",onClick:()=>v(o.id),disabled:o.status===N.DOWNLOADED,children:e.jsx(Ke,{})})}),o.status===N.DOWNLOADED&&e.jsx(T,{title:"已下載",children:e.jsx(ie,{color:"success",className:"ml-2"})})]},o.id))})]})]})})})})}function Jt(){const[t,i]=pt(),n=t.get("roomId"),l=t.get("isHost");return e.jsxs(P,{sx:{flex:"1 1 auto"},children:[e.jsx(kt,{roomId:n,isHost:l}),e.jsx(ye,{children:e.jsx(Ce,{path:"/",element:e.jsx(Ut,{})})})]})}function Ht(t){const{title:i}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function qt(){return W("(min-width:900px)"),e.jsx(P,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(P,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(Jt,{}),e.jsx(Ht,{title:null})]})})}function Qt(){const{open:t,closeAlert:i,title:n,content:l,handleAgree:r,handleDisagree:u}=Se(d=>d);return e.jsxs(Z,{open:t,onClose:i,children:[e.jsx(V,{children:n}),e.jsx(X,{children:e.jsx(ke,{sx:{whiteSpace:"pre-line"},children:l})}),e.jsxs(Y,{children:[e.jsx(F,{onClick:i,children:"取消"}),e.jsx(F,{onClick:()=>r(i),autoFocus:!0,children:"確認"})]})]})}function Zt(t){var v;const{children:i,margin:n=15,sx:l={},content_sx:r={},data:u=null,onlyProps:d=!1,noDrawer:s=!1}=t,g=((v=Ae())==null?void 0:v.isDrawerOpen)&&!s,p=W(g?"(min-width:1440px)":"(min-width:1200px)"),y=W(g?"(min-width:1232px)":"(min-width:992px)"),C=W(g?"(min-width:1008px)":"(min-width:768px)");let h=p?"1170px":y?"970px":C?"750px":"100%",b=(u==null?void 0:u.length)<3?`${100/u.length}%`:p?1170/3:y?970/3:C?750/2:h;const x={content_width:h,margin:`${n}px`,width:b,width_margin:typeof b!="string"?b-n*2:`calc(${b} - ${n*2}px)`,lg:p,md:y,xs:C};return d==!0?e.jsx(j.Fragment,{children:j.cloneElement(i,{...x})}):e.jsx(P,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...l},children:e.jsx(P,{sx:{width:h,display:"flex",flexWrap:"wrap",...r},children:j.cloneElement(i,{...x})})})}const Vt=Je(Z)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function Xt(t){const{isRwdWidth:i}=t;return i?e.jsx(Zt,{onlyProps:!0,noDrawer:!0,children:e.jsx(he,{...t})}):e.jsx(he,{...t})}const he=t=>{const{content_width:i,open:n,title:l,content:r,actions:u,body:d,closeDialog:s,disableScrollLock:g,fullWidth:p,fullHeight:y,maxWidth:C,fullScreen:h,isRwdWidth:b,contentProps:x={}}=t,v=b?{sx:{width:"100%",maxWidth:`${i} !important`,height:y?"100%":"auto"}}:{fullWidth:p,maxWidth:C,fullScreen:h};return e.jsxs(Vt,{onClose:s,open:n,disableScrollLock:!!g,...b?{}:v,PaperProps:{...b?v:{}},children:[e.jsxs(P,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(V,{sx:{m:0,p:0,pl:1},children:l}),e.jsx(G,{onClick:s,sx:{color:w=>w.palette.grey[500]},children:e.jsx(He,{})})]}),d?j.cloneElement(d,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(X,{dividers:!0,sx:{...x},children:!!r&&j.cloneElement(r,{closeDialog:s})}),!!u&&e.jsx(Y,{children:j.cloneElement(u,{closeDialog:s})})]})]})},Yt=()=>{const{...t}=Wt();return e.jsxs(e.Fragment,{children:[e.jsx(Gt,{title:"SAF Kanban"}),e.jsx(qt,{}),e.jsx(Qt,{}),e.jsx(vt,{}),e.jsx(Xt,{...t})]})},en={},_=J(en,async(t,i,n)=>{let l=t(_);i(_,{...l,...n})}),tn=()=>{const[{...t},i]=R(_),n=({key:l,body:r})=>{console.log(`apiDataAtom log (${l}):`,{...t,[l]:r}),i({[l]:r})};return{...ut(_),setApiData:n}},nn=()=>{const{setSnackMsg:t}=H(s=>s),{setApiData:i}=tn(),n=(s=[])=>{let g="";s==null||s.map((p,y)=>{g+=(y==0?"":`

`)+((p==null?void 0:p.displayName)||(p==null?void 0:p.field))+`：
`+(p==null?void 0:p.error)}),setAlert({title:"錯誤",content:g,handleAgree:p=>p()})},l=(s,g,p)=>{console.log("onError",s,g),t({message:"API發生未知錯誤"})},r=async(s,g)=>{var y,C,h,b,x,v,w,A,D,I,o;((C=(y=g==null?void 0:g.queryKey)==null?void 0:y[0])==null?void 0:C[0])=="_"&&i({key:(b=(h=g==null?void 0:g.queryKey)==null?void 0:h[0])==null?void 0:b.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(x=g==null?void 0:g.options)==null?void 0:x.queryFn}});const p=((v=s==null?void 0:s.body)==null?void 0:v.status)!==null&&((w=s==null?void 0:s.body)==null?void 0:w.status)!==void 0?(A=s==null?void 0:s.body)==null?void 0:A.status:null;p!==null&&Array.isArray((D=s==null?void 0:s.body)==null?void 0:D.errorArray)?n((I=s==null?void 0:s.body)==null?void 0:I.errorArray):p!==null&&t({message:(o=s==null?void 0:s.body)==null?void 0:o.message}),!(s!=null&&s.ok)&&p==null&&!(s!=null&&s.pages)&&t({message:"API發生未知錯誤！"})},u=(s,g)=>{},d=new Qe({queryCache:new Ve({onSuccess:r,onError:l,onSettled:u}),mutationCache:new Ze({onSuccess:r,onError:l}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var y,C,h,b;let p=(((y=s==null?void 0:s.body)==null?void 0:y.status)!==null&&((C=s==null?void 0:s.body)==null?void 0:C.status)!==void 0?(h=s==null?void 0:s.body)==null?void 0:h.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let x=[];(b=s==null?void 0:s.pages)==null||b.map((v,w)=>{x[w]=(v==null?void 0:v.body)||v}),p={...s,pages:x}}return p}}}});return e.jsx(Xe,{client:d,children:e.jsx(xt,{basename:"/SAF_Kanban/",children:e.jsx(Yt,{})})})},sn=document.getElementById("root");$e.createRoot(sn).render(e.jsx(nn,{}));
