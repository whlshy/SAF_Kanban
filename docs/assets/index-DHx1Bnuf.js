import{j as e,R as q,r as b}from"./react-BkCFb41Y.js";import{a as Oe}from"./react-dom-BcT_u2RR.js";import{c as U}from"./zustand-DLhad_yI.js";import{B as T,S as $e,a as ke,b as Le,c as L,A as Pe,T as Te,d as $,I as W,e as Fe,D as Q,f as Z,g as V,h as J,i as X,P as Re,L as ne,j as se,k as re,l as Be,m as P,C as Ue,n as oe,E as Ke,H as Me,o as ze,p as We,u as z,q as Ge,s as _e,r as He}from"./@mui-DmHrF7Nm.js";import{u as Je,b as xe,c as fe}from"./react-router-COu1yu9k.js";import{u as qe,B as Qe}from"./react-router-dom-BpY5ankm.js";import{u as ie,a as Ze,Q as Ve,M as Xe,b as Ye,c as et}from"./@tanstack-DpQXpXmE.js";import{S as _}from"./@radix-ui-B08lzGHt.js";import{c as be}from"./class-variance-authority-Dp3B9jqt.js";import{c as tt}from"./clsx-B-dksMZM.js";import{t as nt}from"./tailwind-merge-BZSatpsL.js";import{u as st,a as ae,b as le,D as rt,S as ve,r as ot,c as it,d as at,e as lt,s as ct,K as dt,P as ut,f as je,C as ye,v as mt}from"./@dnd-kit-Le8HzPvy.js";import{u as F,a as H,b as gt}from"./jotai-B-Mb4bjH.js";import{a as pt}from"./axios-Dnk_-Q5K.js";import"./react-qr-code-Bf0iBglm.js";import{$ as ce}from"./peerjs-DxFR7Coi.js";import{v as ht}from"./uuid-C6aID195.js";import"./@babel-B_fy3T9z.js";import"./scheduler-C323NY8X.js";import"./react-is-BwqtTtay.js";import"./react-transition-group-CEW9j9Fk.js";import"./@emotion-B9jP_P4v.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-DzGuYBkV.js";import"./sdp-C8-99_ry.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(o){if(o.ep)return;o.ep=!0;const d=n(o);fetch(o.href,d)}})();const K=t=>(r,n,a)=>t((...o)=>{console.log("  applying",o),r(...o),console.log("  new state",n())},n,a),de={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},Y=U(K((t,r)=>({...de,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(de)})));function xt(t){return e.jsx(Le,{...t,direction:"down"})}function ft(t){const{snackbar:r,closeSnackbar:n,message:a,open:o,anchorOrigin:d,autoHideDuration:c,status:s}=Y(j=>j),p=e.jsx(q.Fragment,{children:e.jsx(T,{color:"inherit",size:"small",onClick:n,children:"確認"})}),u=j=>{switch(j){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx($e,{open:o,onClose:n,anchorOrigin:d,TransitionComponent:xt,autoHideDuration:c,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(ke,{message:s!=null?u(s):a,action:p})})})})}const bt="",vt={apiurl:bt},jt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};U(K((t,r)=>({...jt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const ue={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},yt=U(K((t,r)=>({...ue,setAlert:n=>t({...ue,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Ct={isSidebarOpen:!0},Ce=U(K((t,r)=>({...Ct,setSidebarOpen:(n=null)=>t(a=>({isSidebarOpen:n!==null?n:!a.isSidebarOpen}))}))),me={open:!1,title:"",content:null,actions:null,body:null},wt=U(K((t,r)=>({...me,setDialog:n=>t({...me,...n,open:!0}),closeDialog:()=>t({open:!1})})));function Dt(t){const{title:r,name:n,logout:a}=t,{setSidebarOpen:o}=Ce();return Je(),e.jsx(L,{sx:{flexGrow:1},children:e.jsx(Pe,{position:"fixed",sx:{zIndex:d=>d.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Te,{children:[e.jsx($,{variant:"h6",component:"div",children:r}),e.jsx(L,{sx:{flexGrow:1}}),e.jsx(W,{style:{color:"white"},children:e.jsx(Fe,{})})]})})})}function k(...t){return nt(tt(t))}const St=be("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function we({className:t,variant:r,asChild:n=!1,...a}){const o=n?_:"span";return e.jsx(o,{"data-slot":"badge",className:k(St({variant:r}),t),...a})}const It=be("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function ge({className:t,variant:r,size:n,asChild:a=!1,...o}){const d=a?_:"button";return e.jsx(d,{"data-slot":"button",className:k(It({variant:r,size:n,className:t})),...o})}const R=b.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),Et=b.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),De=b.createContext({listeners:void 0,isDragging:!1,disabled:!1}),At={...lt,sideEffects:at({styles:{active:{opacity:"0.4"}}})};function Nt({value:t,onValueChange:r,getItemValue:n,children:a,className:o,onMove:d}){const c=t,s=r,[p,u]=b.useState(null),j=st(ae(ut,{activationConstraint:{distance:10}}),ae(dt,{coordinateGetter:ct})),v=b.useMemo(()=>Object.keys(c),[c]),l=b.useCallback(S=>v.includes(S),[v]),h=b.useCallback(S=>l(S)?S:v.find(w=>c[w].some(i=>n(i)===S)),[c,v,n,l]),f=b.useCallback(S=>{u(S.active.id)},[]),C=b.useCallback(S=>{if(d)return;const{active:w,over:i}=S;if(!i||l(w.id))return;const x=h(w.id),m=h(i.id);if(!x||!m||x===m)return;const g=c[x],y=c[m],E=g.findIndex(B=>n(B)===w.id);let I=y.findIndex(B=>n(B)===i.id);l(i.id)&&(I=y.length);const N=[...y],[M]=g.splice(E,1);N.splice(I,0,M),s({...c,[x]:[...g],[m]:N})},[h,n,l,s,c,d]),D=b.useCallback(S=>{const{active:w,over:i}=S;if(u(null),!i)return;if(d&&!l(w.id)){const g=h(w.id),y=h(i.id);if(g&&y){const E=c[g].findIndex(N=>n(N)===w.id),I=l(i.id)?c[y].length:c[y].findIndex(N=>n(N)===i.id);d({event:S,activeContainer:g,activeIndex:E,overContainer:y,overIndex:I})}return}if(l(w.id)&&l(i.id)){const g=v.indexOf(w.id),y=v.indexOf(i.id);if(g!==y){const E=le(Object.keys(c),g,y),I={};E.forEach(N=>{I[N]=c[N]}),s(I)}return}const x=h(w.id),m=h(i.id);if(x&&m&&x===m){const g=x,y=c[g].findIndex(I=>n(I)===w.id),E=c[g].findIndex(I=>n(I)===i.id);y!==E&&s({...c,[g]:le(c[g],y,E)})}},[v,c,h,n,l,s,d]),O=b.useMemo(()=>({columns:c,setColumns:s,getItemId:n,columnIds:v,activeId:p,setActiveId:u,findContainer:h,isColumn:l}),[c,s,n,v,p,h,l]);return e.jsx(R.Provider,{value:O,children:e.jsx(rt,{sensors:j,onDragStart:f,onDragOver:C,onDragEnd:D,children:e.jsx("div",{"data-slot":"kanban","data-dragging":p!==null,className:k(o),children:a})})})}function Ot({children:t,className:r}){const{columnIds:n}=b.useContext(R);return e.jsx(ve,{items:n,strategy:ot,children:e.jsx("div",{"data-slot":"kanban-board",className:k("grid auto-rows-fr sm:grid-cols-4 gap-4",r),children:t})})}function $t({value:t,className:r,children:n,disabled:a}){const{setNodeRef:o,transform:d,transition:c,attributes:s,listeners:p,isDragging:u}=je({id:t,disabled:a}),{activeId:j,isColumn:v}=b.useContext(R),l=j?v(j):!1,h={transition:c,transform:ye.Translate.toString(d)};return e.jsx(Et.Provider,{value:{attributes:s,listeners:p,isDragging:l,disabled:a},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":u,"data-disabled":a,ref:o,style:h,className:k("group/kanban-column flex flex-col",u&&"opacity-50",a&&"opacity-50",r),children:n})})}function kt({value:t,asChild:r=!1,className:n,children:a,disabled:o}){const{setNodeRef:d,transform:c,transition:s,attributes:p,listeners:u,isDragging:j}=je({id:t,disabled:o}),{activeId:v,isColumn:l}=b.useContext(R),h=v?!l(v):!1,f={transition:s,transform:ye.Translate.toString(c)},C=r?_:"div";return e.jsx(De.Provider,{value:{listeners:u,isDragging:h,disabled:o},children:e.jsx(C,{"data-slot":"kanban-item","data-value":t,"data-dragging":j,"data-disabled":o,ref:d,style:f,...p,className:k(j&&"opacity-50",o&&"opacity-50",n),children:a})})}function Lt({asChild:t,className:r,children:n,cursor:a=!0}){const[,o]=F(Ee),{listeners:d,isDragging:c,disabled:s}=b.useContext(De);b.useEffect(()=>{o(c)},[c]);const p=t?_:"div";return e.jsx(p,{"data-slot":"kanban-item-handle","data-dragging":c,"data-disabled":s,...d,className:k(a&&(c?"!cursor-grabbing":"!cursor-grab"),r),children:n})}function Pt({value:t,className:r,children:n}){const{columns:a,getItemId:o}=b.useContext(R),d=b.useMemo(()=>a[t].map(o),[a,o,t]);return e.jsx(ve,{items:d,strategy:mt,children:e.jsx("div",{"data-slot":"kanban-column-content",className:k("flex flex-col gap-2",r),children:n})})}function Tt({children:t,className:r}){const{activeId:n,isColumn:a}=b.useContext(R),[o,d]=b.useState(null);b.useEffect(()=>{if(n){const p=document.querySelector(`[data-slot="kanban-${a(n)?"column":"item"}"][data-value="${n}"]`);if(p){const u=p.getBoundingClientRect();d({width:u.width,height:u.height})}}else d(null)},[n]);const c={width:o==null?void 0:o.width,height:o==null?void 0:o.height},s=b.useMemo(()=>n?typeof t=="function"?t({value:n,variant:a(n)?"column":"item"}):t:null,[n,t,a]);return e.jsx(it,{dropAnimation:At,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:c,className:k("pointer-events-none",r,n?"!cursor-grabbing":""),children:s})})}const{apiurl:Ft}=vt;function ee({cmd:t,cmd_url:r=null,method:n="GET",type:a="json",data:o={},header:d={},fileList:c=[],fileObj:s={}}){var j,v;n=n.toUpperCase(),a=a.toLowerCase();let p=r??`${Ft}/${t}`,u={method:n,headers:{"Content-Type":"application/json",...d}};if(c.length||((j=Object.keys(s))==null?void 0:j.length)>0){let l=new FormData;u.headers["Content-Type"]="multipart/form-data",[...c].forEach(f=>{l.append("files",f)}),(v=Object.keys(s))==null||v.map(f=>{Array.isArray(s[f])?[...s[f]].forEach(D=>{l.append(f,D)}):l.append(f,s[f])}),Object.keys(o).map(f=>{l.append(f,o[f])}),o=l}switch(n){case"POST":case"PUT":case"DELETE":u.data=o;break;case"GET":u.params=o;break}return pt({method:n,url:p,...u,withCredentials:!1}).then(l=>({ok:l.status=="200"||l.status=="403",status:l.status,body:l.data})).catch(l=>{let h=l.response;if(h)return{ok:h.status=="200",status:h.status,body:h.data};throw new Error({ok:!1,status:404,body:l.message})})}const Rt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Bt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Ut=async({list:t=[]})=>await ee({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),Kt=t=>t.map(r=>({id:r[0],title:r[1],jiraId:r[2],des:r[3],task:r[4],priority:r[5],assignee:r[6]})),Se=H({open:!1});function Mt(){var o,d;const t=ie({queryKey:["getGoogleSheetIssue"],queryFn:()=>Rt()}),r=ie({queryKey:["getGoogleSheetTask"],queryFn:()=>Bt()}),n=Kt(((o=t==null?void 0:t.data)==null?void 0:o.values)||[]),a=((d=r==null?void 0:r.data)==null?void 0:d.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(zt,{tasks:a,issues:n})})}function Ie({task:t,asHandle:r,...n}){const[,a]=F(Se),o=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>a({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"line-clamp-1 font-medium text-sm",children:t.title}),e.jsx(we,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[t.jiraId&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(kt,{value:t.id,...n,children:r?e.jsx(Lt,{children:o}):o})}function pe({value:t,tasks:r,isOverlay:n,...a}){return e.jsxs($t,{value:t,...a,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(we,{variant:"secondary",children:r.length})]})}),e.jsx(Pt,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:r.map(o=>e.jsx(Ie,{task:o,asHandle:!n},o.id))})]})}const Ee=H(!1);function zt({tasks:t,issues:r}){const[n,a]=q.useState({}),[o,d]=q.useState(!1),[c]=F(Ee),[s,p]=F(Se),u=Ze({mutationFn:Ut});b.useEffect(()=>{if(Array.isArray(r)&&Array.isArray(t)){let l={};t==null||t.map(h=>{let f=h[0];l[f]=r==null?void 0:r.filter(C=>C.task==f)}),a(l)}},[r,t]),b.useEffect(()=>{var l;if(o){console.log("handle change google sheet"),d(!1);let h=[];(l=Object.keys(n))==null||l.map(f=>{let C=n[f].map(D=>[D.id,D.title,D.jiraId,D.des,f,D.priority,D.assignee]);h=h.concat(C)}),u.mutate({list:h},{onSuccess:f=>console.log(f)})}},[c]);const j=l=>{d(!0),a(l)},v=(l,h)=>{var f,C;if(l!=null&&l.id){let D=JSON.parse(JSON.stringify(n));(f=Object.keys(n))==null||f.map(S=>{D[S]=D[S].map(w=>(w==null?void 0:w.id)==(l==null?void 0:l.id)?{...w,...l}:w)});let O=[];(C=Object.keys(D))==null||C.map(S=>{let w=D[S].map(i=>[i.id,i.title,i.jiraId,i.des,S,i.priority,i.assignee]);O=O.concat(w)}),u.mutate({list:O},{onSuccess:()=>h==null?void 0:h()})}};return e.jsxs(e.Fragment,{children:[e.jsxs(Nt,{value:n,onValueChange:j,getItemValue:l=>l.id,children:[e.jsx(Ot,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(n).map(([l,h])=>e.jsx(pe,{value:l,tasks:h},l))}),e.jsx(Tt,{children:({value:l,variant:h})=>{if(h==="column"){const C=n[l]||[];return e.jsx(pe,{value:l,tasks:C,isOverlay:!0})}const f=Object.values(n).flat().find(C=>C.id===l);return f?e.jsx(Ie,{task:f}):null}})]}),!!s.open&&e.jsx(Q,{open:s.open,onClose:()=>p({open:!1}),fullWidth:!0,maxWidth:"lg",children:e.jsx(Wt,{task:s.task,onClose:()=>p({open:!1}),onOk:v})})]})}const Wt=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"",assignee:""},onClose:r,onOk:n})=>{const[a,o]=b.useState(t);return e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(V,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(J,{label:"Title",variant:"standard",value:(a==null?void 0:a.title)||"",onChange:d=>o(c=>({...c,title:d.target.value})),fullWidth:!0}),e.jsx(J,{label:"jiraId",variant:"standard",defaultValue:(a==null?void 0:a.jiraId)||"",onChange:d=>o(c=>({...c,title:d.target.value})),fullWidth:!0}),e.jsx(J,{label:"Des",variant:"standard",defaultValue:(a==null?void 0:a.des)||"",onChange:d=>o(c=>({...c,title:d.target.value})),fullWidth:!0})]}),e.jsxs(X,{children:[e.jsx(ge,{onClick:r,children:"Cancel"}),e.jsx(ge,{onClick:()=>n(a,r),children:"OK"})]})]})},A={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},Gt=H(!1);function _t({roomId:t,isHost:r}){const[n,a]=b.useState(null),[o,d]=F(Gt),c=b.useRef(null),[s,p]=b.useState([]),[u,j]=b.useState([]),v=b.useRef({}),{setSnackMsg:l}=Y();b.useEffect(()=>{let i;if(t)return r?(i=new ce(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(i=new ce(void 0),console.log("Joiner attempting to open Peer with a random ID")),a(i),()=>{i&&!(i!=null&&i.destroyed)&&(console.log("Destroying peer instance:",i.id),i.destroy()),a(null),p([]),j([])}},[t,r]),b.useEffect(()=>{if(!n)return;n.removeAllListeners();const i=m=>console.error("PeerJS error:",m);n.on("error",i);const x=m=>{c.current=m,m.on("open",()=>{d(!0),console.log(`DataConnection open with ${m.peer}`)}),m.on("close",()=>{d(!1),c.current=null,console.log(`DataConnection closed with ${m.peer}`)}),m.on("error",g=>{console.error(`DataConnection error with ${m.peer}:`,g),d(!1)}),m.on("data",g=>{if(r)g.type==="file-received-ack"?(console.log(`Host: ACK for file ${g.fileId}`),p(y=>y.map(E=>E.id===g.fileId?{...E,status:A.SENT}:E))):g.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${g.fileId}: ${g.error}`),p(y=>y.map(E=>E.id===g.fileId?{...E,status:A.FAILED}:E)));else if(console.log("blob in",g),g.type==="file-metadata")console.log("Joiner: Received file metadata",g),v.current[g.fileId]=g;else if(g instanceof Blob||g instanceof ArrayBuffer||g instanceof Uint8Array){let y=null;const E=Object.keys(v.current).filter(I=>!u.some(N=>N.id===I));if(E.length>0){const I=E[E.length-1];I&&v.current[I]&&(y=v.current[I])}if(y){const{fileId:I,name:N,mimeType:M,size:B}=y;console.log(`Joiner: Received blob for ${N} (ID: ${I})`);const te=g instanceof Blob?g:new Blob([g],{type:M}),Ae=URL.createObjectURL(te);j(Ne=>[...Ne,{id:I,name:N,type:M,size:B,blobUrl:Ae,blobObject:te,status:A.RECEIVED}]),m.send({type:"file-received-ack",fileId:I}),delete v.current[I]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else g.type==="batch-meta"&&console.log("Joiner: Received batch metadata",g)})};r?(n.on("open",m=>console.log(`Host Peer opened: ${m}`)),n.on("connection",x)):n.on("open",m=>{if(console.log(`Joiner Peer opened: ${m}`),t){const g=n.connect(t);x(g)}})},[n,t,r,u]);const h=i=>{const x=Array.from(i.target.files).map(m=>({id:ht(),name:m.name,size:m.size,type:m.type,previewUrl:URL.createObjectURL(m),status:A.SELECTED,fileObject:m}));p(m=>[...m,...x]),i.target.value=null},f=async()=>{if(!o||!c.current){alert("連線未建立!");return}const i=s.filter(x=>x.status===A.SELECTED);if(i.length===0){alert("沒有已選擇的檔案可傳送。");return}c.current.send({type:"batch-meta",totalFiles:i.length});for(const x of i){p(m=>m.map(g=>g.id===x.id?{...g,status:A.SENDING}:g));try{const m={type:"file-metadata",fileId:x.id,name:x.name,mimeType:x.type,size:x.size};c.current.send(m)}catch(m){console.error(`Host: Error sending file ${x.name}:`,m),p(g=>g.map(y=>y.id===x.id?{...y,status:A.FAILED}:y))}}for(const x of i)try{await new Promise(m=>setTimeout(m,50)),c.current.send(x.fileObject),console.log(`Host: Sent ${x.name} (ID: ${x.id})`)}catch(m){console.error(`Host: Error sending file ${x.name}:`,m),p(g=>g.map(y=>y.id===x.id?{...y,status:A.FAILED}:y))}},C=i=>{const x=u.find(m=>m.id===i);if(x){const m=document.createElement("a");m.href=x.blobUrl,m.download=x.name,document.body.appendChild(m),m.click(),document.body.removeChild(m),j(g=>g.map(y=>y.id===i?{...y,status:A.DOWNLOADED}:y))}},D=async()=>{const i=u.filter(x=>x.status===A.RECEIVED&&x.blobUrl);if(i.length===0){l({message:"沒有可下載的新檔案。"});return}for(let x=0;x<i.length;x++){const m=i[x];console.log(`Auto-downloading ${x+1}/${i.length}: ${m.name}`),C(m.id),x<i.length-1&&await new Promise(g=>setTimeout(g,500))}l({message:`${i.length} 個檔案已開始下載。`})},O=u.some(i=>i.status===A.RECEIVED&&i.blobUrl),S=i=>{const x=s.filter(m=>m.id!==i);p(x)},w=(i,x=null)=>{switch(i){case A.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(P,{title:"已選擇",children:e.jsx(ze,{color:"action"})}),e.jsx(P,{title:"刪除",children:e.jsx(W,{sx:{ml:1},onClick:()=>S(x),children:e.jsx(We,{color:"action"})})})]});case A.SENDING:return e.jsx(P,{title:"傳送中",children:e.jsx(Me,{color:"primary",className:"animate-spin"})});case A.SENT:return e.jsx(P,{title:"已傳送",children:e.jsx(oe,{color:"success"})});case A.FAILED:return e.jsx(P,{title:"失敗",children:e.jsx(Ke,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(xe,{children:e.jsx(fe,{path:"/transfer",element:e.jsxs(Re,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs($,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",r?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs($,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),r&&e.jsxs($,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs($,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${o?"bg-green-500":"bg-red-500"}`,children:o?"已連線":"未連線"})]})]}),r&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx($,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(T,{variant:"outlined",component:"label",disabled:!o,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:h})]}),e.jsx(T,{variant:"contained",color:"primary",onClick:f,disabled:!o||!s.some(i=>i.status===A.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(ne,{dense:!0,children:s.map(i=>e.jsxs(se,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:i.previewUrl,alt:i.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(re,{primary:e.jsx("span",{className:"font-medium",children:i.name}),secondary:`${(i.size/1024).toFixed(1)} KB - 狀態: ${i.status}`}),e.jsx("div",{className:"ml-auto",children:w(i.status,i.id)})]},i.id))})]}),!r&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs($,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),u.length>0&&e.jsx(T,{variant:"contained",size:"small",startIcon:e.jsx(Be,{}),onClick:D,disabled:!O||!o,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),u.length===0&&o&&e.jsx($,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),u.length===0&&!o&&e.jsx($,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),u.length>0&&e.jsx(ne,{dense:!0,children:u.map(i=>e.jsxs(se,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:i.blobUrl,alt:i.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(re,{primary:e.jsx("span",{className:"font-medium",children:i.name}),secondary:`${(i.size/1024).toFixed(1)} KB`}),e.jsx(P,{title:"下載檔案",children:e.jsx(W,{color:"primary",onClick:()=>C(i.id),disabled:i.status===A.DOWNLOADED,children:e.jsx(Ue,{})})}),i.status===A.DOWNLOADED&&e.jsx(P,{title:"已下載",children:e.jsx(oe,{color:"success",className:"ml-2"})})]},i.id))})]})]})})})})}function Ht(){const[t,r]=qe(),n=t.get("roomId"),a=t.get("isHost");return e.jsxs(L,{sx:{flex:"1 1 auto"},children:[e.jsx(_t,{roomId:n,isHost:a}),e.jsx(xe,{children:e.jsx(fe,{path:"/",element:e.jsx(Mt,{})})})]})}function Jt(t){const{title:r}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function qt(){return z("(min-width:900px)"),e.jsx(L,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(L,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(Ht,{}),e.jsx(Jt,{title:null})]})})}function Qt(){const{open:t,closeAlert:r,title:n,content:a,handleAgree:o,handleDisagree:d}=yt(c=>c);return e.jsxs(Q,{open:t,onClose:r,children:[e.jsx(Z,{children:n}),e.jsx(V,{children:e.jsx(Ge,{sx:{whiteSpace:"pre-line"},children:a})}),e.jsxs(X,{children:[e.jsx(T,{onClick:r,children:"取消"}),e.jsx(T,{onClick:()=>o(r),autoFocus:!0,children:"確認"})]})]})}function Zt(t){var C;const{children:r,margin:n=15,sx:a={},content_sx:o={},data:d=null,onlyProps:c=!1,noDrawer:s=!1}=t,p=((C=Ce())==null?void 0:C.isDrawerOpen)&&!s,u=z(p?"(min-width:1440px)":"(min-width:1200px)"),j=z(p?"(min-width:1232px)":"(min-width:992px)"),v=z(p?"(min-width:1008px)":"(min-width:768px)");let l=u?"1170px":j?"970px":v?"750px":"100%",h=(d==null?void 0:d.length)<3?`${100/d.length}%`:u?1170/3:j?970/3:v?750/2:l;const f={content_width:l,margin:`${n}px`,width:h,width_margin:typeof h!="string"?h-n*2:`calc(${h} - ${n*2}px)`,lg:u,md:j,xs:v};return c==!0?e.jsx(b.Fragment,{children:b.cloneElement(r,{...f})}):e.jsx(L,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...a},children:e.jsx(L,{sx:{width:l,display:"flex",flexWrap:"wrap",...o},children:b.cloneElement(r,{...f})})})}const Vt=_e(Q)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function Xt(t){const{isRwdWidth:r}=t;return r?e.jsx(Zt,{onlyProps:!0,noDrawer:!0,children:e.jsx(he,{...t})}):e.jsx(he,{...t})}const he=t=>{const{content_width:r,open:n,title:a,content:o,actions:d,body:c,closeDialog:s,disableScrollLock:p,fullWidth:u,fullHeight:j,maxWidth:v,fullScreen:l,isRwdWidth:h,contentProps:f={}}=t,C=h?{sx:{width:"100%",maxWidth:`${r} !important`,height:j?"100%":"auto"}}:{fullWidth:u,maxWidth:v,fullScreen:l};return e.jsxs(Vt,{onClose:s,open:n,disableScrollLock:!!p,...h?{}:C,PaperProps:{...h?C:{}},children:[e.jsxs(L,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(Z,{sx:{m:0,p:0,pl:1},children:a}),e.jsx(W,{onClick:s,sx:{color:D=>D.palette.grey[500]},children:e.jsx(He,{})})]}),c?b.cloneElement(c,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(V,{dividers:!0,sx:{...f},children:!!o&&b.cloneElement(o,{closeDialog:s})}),!!d&&e.jsx(X,{children:b.cloneElement(d,{closeDialog:s})})]})]})},Yt=()=>{const{...t}=wt();return e.jsxs(e.Fragment,{children:[e.jsx(Dt,{title:"SAF Kanban"}),e.jsx(qt,{}),e.jsx(Qt,{}),e.jsx(ft,{}),e.jsx(Xt,{...t})]})},en={},G=H(en,async(t,r,n)=>{let a=t(G);r(G,{...a,...n})}),tn=()=>{const[{...t},r]=F(G),n=({key:a,body:o})=>{console.log(`apiDataAtom log (${a}):`,{...t,[a]:o}),r({[a]:o})};return{...gt(G),setApiData:n}},nn=()=>{const{setSnackMsg:t}=Y(s=>s),{setApiData:r}=tn(),n=(s=[])=>{let p="";s==null||s.map((u,j)=>{p+=(j==0?"":`

`)+((u==null?void 0:u.displayName)||(u==null?void 0:u.field))+`：
`+(u==null?void 0:u.error)}),setAlert({title:"錯誤",content:p,handleAgree:u=>u()})},a=(s,p,u)=>{console.log("onError",s,p),t({message:"API發生未知錯誤"})},o=async(s,p)=>{var j,v,l,h,f,C,D,O,S,w,i;((v=(j=p==null?void 0:p.queryKey)==null?void 0:j[0])==null?void 0:v[0])=="_"&&r({key:(h=(l=p==null?void 0:p.queryKey)==null?void 0:l[0])==null?void 0:h.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(f=p==null?void 0:p.options)==null?void 0:f.queryFn}});const u=((C=s==null?void 0:s.body)==null?void 0:C.status)!==null&&((D=s==null?void 0:s.body)==null?void 0:D.status)!==void 0?(O=s==null?void 0:s.body)==null?void 0:O.status:null;u!==null&&Array.isArray((S=s==null?void 0:s.body)==null?void 0:S.errorArray)?n((w=s==null?void 0:s.body)==null?void 0:w.errorArray):u!==null&&t({message:(i=s==null?void 0:s.body)==null?void 0:i.message}),!(s!=null&&s.ok)&&u==null&&!(s!=null&&s.pages)&&t({message:"API發生未知錯誤！"})},d=(s,p)=>{},c=new Ve({queryCache:new Ye({onSuccess:o,onError:a,onSettled:d}),mutationCache:new Xe({onSuccess:o,onError:a}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var j,v,l,h;let u=(((j=s==null?void 0:s.body)==null?void 0:j.status)!==null&&((v=s==null?void 0:s.body)==null?void 0:v.status)!==void 0?(l=s==null?void 0:s.body)==null?void 0:l.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let f=[];(h=s==null?void 0:s.pages)==null||h.map((C,D)=>{f[D]=(C==null?void 0:C.body)||C}),u={...s,pages:f}}return u}}}});return e.jsx(et,{client:c,children:e.jsx(Qe,{basename:"/SAF_Kanban/",children:e.jsx(Yt,{})})})},sn=document.getElementById("root");Oe.createRoot(sn).render(e.jsx(nn,{}));
