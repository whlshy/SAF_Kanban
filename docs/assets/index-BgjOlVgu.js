import{j as e,R as q,r as v}from"./react-BkCFb41Y.js";import{a as Oe}from"./react-dom-BcT_u2RR.js";import{c as B}from"./zustand-DLhad_yI.js";import{B as k,S as $e,a as Le,b as Pe,D as Q,c as Z,d as V,T as J,e as X,f as P,A as Fe,g as Te,h as $,I as W,i as ke,P as Re,L as se,j as re,k as oe,l as Ue,m as F,C as Be,n as ie,E as Ke,H as Me,o as ze,p as We,u as z,q as Ge,s as _e,r as He}from"./@mui-xlN6yUIm.js";import{u as ae,a as Je,Q as qe,M as Qe,b as Ze,c as Ve}from"./@tanstack-DpQXpXmE.js";import{S as _}from"./@radix-ui-B08lzGHt.js";import{c as fe}from"./class-variance-authority-Dp3B9jqt.js";import{c as Xe}from"./clsx-B-dksMZM.js";import{t as Ye}from"./tailwind-merge-BZSatpsL.js";import{u as et,a as le,b as ce,D as tt,S as be,r as nt,c as st,d as rt,e as ot,s as it,K as at,P as lt,f as ve,C as je,v as ct}from"./@dnd-kit-Le8HzPvy.js";import{u as T,a as H,b as dt}from"./jotai-B-Mb4bjH.js";import{a as ut}from"./axios-Dnk_-Q5K.js";import{u as mt,b as ye,c as Ce}from"./react-router-COu1yu9k.js";import{u as gt,B as pt}from"./react-router-dom-BpY5ankm.js";import"./react-qr-code-Bf0iBglm.js";import{$ as de}from"./peerjs-DxFR7Coi.js";import{v as ht}from"./uuid-C6aID195.js";import"./@babel-B_fy3T9z.js";import"./scheduler-C323NY8X.js";import"./react-is-BwqtTtay.js";import"./react-transition-group-CEW9j9Fk.js";import"./@emotion-B9jP_P4v.js";import"./hoist-non-react-statics-C-Qo8PK8.js";import"./stylis-DDa9OTMq.js";import"./@popperjs-CMBiYTiD.js";import"./@remix-run-tn2ilB4G.js";import"./prop-types-Chjiymov.js";import"./qr.js-D7uXRtkb.js";import"./peerjs-js-binarypack-0qb93TeF.js";import"./webrtc-adapter-DzGuYBkV.js";import"./sdp-C8-99_ry.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const u of o)if(u.type==="childList")for(const c of u.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const u={};return o.integrity&&(u.integrity=o.integrity),o.referrerPolicy&&(u.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?u.credentials="include":o.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function a(o){if(o.ep)return;o.ep=!0;const u=n(o);fetch(o.href,u)}})();const K=t=>(r,n,a)=>t((...o)=>{console.log("  applying",o),r(...o),console.log("  new state",n())},n,a),ue={open:!1,message:null,anchorOrigin:{vertical:"top",horizontal:"center"},autoHideDuration:3e3,status:null},Y=B(K((t,r)=>({...ue,setSnackMsg:n=>t({...n,open:!0}),closeSnackbar:()=>t(ue)})));function xt(t){return e.jsx(Pe,{...t,direction:"down"})}function ft(t){const{snackbar:r,closeSnackbar:n,message:a,open:o,anchorOrigin:u,autoHideDuration:c,status:s}=Y(y=>y),x=e.jsx(q.Fragment,{children:e.jsx(k,{color:"inherit",size:"small",onClick:n,children:"確認"})}),m=y=>{switch(y){case 401:return"沒有權限！";case 500:return"API發生未知錯誤！"}};return e.jsx($e,{open:o,onClose:n,anchorOrigin:u,TransitionComponent:xt,autoHideDuration:c,children:e.jsx("div",{className:"rainbow",children:e.jsx("div",{className:"rainbow-container",children:e.jsx(Le,{message:s!=null?m(s):a,action:x})})})})}function L(...t){return Ye(Xe(t))}const bt=fe("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/70",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function we({className:t,variant:r,asChild:n=!1,...a}){const o=n?_:"span";return e.jsx(o,{"data-slot":"badge",className:L(bt({variant:r}),t),...a})}const vt=fe("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"text-destructive hover-text-foreground bg-secondary border border-border hover:text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:hover:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function me({className:t,variant:r,size:n,asChild:a=!1,...o}){const u=a?_:"button";return e.jsx(u,{"data-slot":"button",className:L(vt({variant:r,size:n,className:t})),...o})}const R=v.createContext({columns:{},setColumns:()=>{},getItemId:()=>"",columnIds:[],activeId:null,setActiveId:()=>{},findContainer:()=>{},isColumn:()=>!1}),jt=v.createContext({attributes:{},listeners:void 0,isDragging:!1,disabled:!1}),De=v.createContext({listeners:void 0,isDragging:!1,disabled:!1}),yt={...ot,sideEffects:rt({styles:{active:{opacity:"0.4"}}})};function Ct({value:t,onValueChange:r,getItemValue:n,children:a,className:o,onMove:u}){const c=t,s=r,[x,m]=v.useState(null),y=et(le(lt,{activationConstraint:{distance:10}}),le(at,{coordinateGetter:it})),j=v.useMemo(()=>Object.keys(c),[c]),l=v.useCallback(w=>j.includes(w),[j]),p=v.useCallback(w=>l(w)?w:j.find(D=>c[D].some(i=>n(i)===w)),[c,j,n,l]),f=v.useCallback(w=>{m(w.active.id)},[]),C=v.useCallback(w=>{if(u)return;const{active:D,over:i}=w;if(!i||l(D.id))return;const g=p(D.id),d=p(i.id);if(!g||!d||g===d)return;const h=c[g],b=c[d],E=h.findIndex(U=>n(U)===D.id);let I=b.findIndex(U=>n(U)===i.id);l(i.id)&&(I=b.length);const N=[...b],[M]=h.splice(E,1);N.splice(I,0,M),s({...c,[g]:[...h],[d]:N})},[p,n,l,s,c,u]),S=v.useCallback(w=>{const{active:D,over:i}=w;if(m(null),!i)return;if(u&&!l(D.id)){const h=p(D.id),b=p(i.id);if(h&&b){const E=c[h].findIndex(N=>n(N)===D.id),I=l(i.id)?c[b].length:c[b].findIndex(N=>n(N)===i.id);u({event:w,activeContainer:h,activeIndex:E,overContainer:b,overIndex:I})}return}if(l(D.id)&&l(i.id)){const h=j.indexOf(D.id),b=j.indexOf(i.id);if(h!==b){const E=ce(Object.keys(c),h,b),I={};E.forEach(N=>{I[N]=c[N]}),s(I)}return}const g=p(D.id),d=p(i.id);if(g&&d&&g===d){const h=g,b=c[h].findIndex(I=>n(I)===D.id),E=c[h].findIndex(I=>n(I)===i.id);b!==E&&s({...c,[h]:ce(c[h],b,E)})}},[j,c,p,n,l,s,u]),O=v.useMemo(()=>({columns:c,setColumns:s,getItemId:n,columnIds:j,activeId:x,setActiveId:m,findContainer:p,isColumn:l}),[c,s,n,j,x,p,l]);return e.jsx(R.Provider,{value:O,children:e.jsx(tt,{sensors:y,onDragStart:f,onDragOver:C,onDragEnd:S,children:e.jsx("div",{"data-slot":"kanban","data-dragging":x!==null,className:L(o),children:a})})})}function wt({children:t,className:r}){const{columnIds:n}=v.useContext(R);return e.jsx(be,{items:n,strategy:nt,children:e.jsx("div",{"data-slot":"kanban-board",className:L("grid auto-rows-fr sm:grid-cols-4 gap-4",r),children:t})})}function Dt({value:t,className:r,children:n,disabled:a}){const{setNodeRef:o,transform:u,transition:c,attributes:s,listeners:x,isDragging:m}=ve({id:t,disabled:a}),{activeId:y,isColumn:j}=v.useContext(R),l=y?j(y):!1,p={transition:c,transform:je.Translate.toString(u)};return e.jsx(jt.Provider,{value:{attributes:s,listeners:x,isDragging:l,disabled:a},children:e.jsx("div",{"data-slot":"kanban-column","data-value":t,"data-dragging":m,"data-disabled":a,ref:o,style:p,className:L("group/kanban-column flex flex-col",m&&"opacity-50",a&&"opacity-50",r),children:n})})}function St({value:t,asChild:r=!1,className:n,children:a,disabled:o}){const{setNodeRef:u,transform:c,transition:s,attributes:x,listeners:m,isDragging:y}=ve({id:t,disabled:o}),{activeId:j,isColumn:l}=v.useContext(R),p=j?!l(j):!1,f={transition:s,transform:je.Translate.toString(c)},C=r?_:"div";return e.jsx(De.Provider,{value:{listeners:m,isDragging:p,disabled:o},children:e.jsx(C,{"data-slot":"kanban-item","data-value":t,"data-dragging":y,"data-disabled":o,ref:u,style:f,...x,className:L(y&&"opacity-50",o&&"opacity-50",n),children:a})})}function It({asChild:t,className:r,children:n,cursor:a=!0}){const[,o]=T(Ie),{listeners:u,isDragging:c,disabled:s}=v.useContext(De);v.useEffect(()=>{o(c)},[c]);const x=t?_:"div";return e.jsx(x,{"data-slot":"kanban-item-handle","data-dragging":c,"data-disabled":s,...u,className:L(a&&(c?"!cursor-grabbing":"!cursor-grab"),r),children:n})}function Et({value:t,className:r,children:n}){const{columns:a,getItemId:o}=v.useContext(R),u=v.useMemo(()=>a[t].map(o),[a,o,t]);return e.jsx(be,{items:u,strategy:ct,children:e.jsx("div",{"data-slot":"kanban-column-content",className:L("flex flex-col gap-2",r),children:n})})}function At({children:t,className:r}){const{activeId:n,isColumn:a}=v.useContext(R),[o,u]=v.useState(null);v.useEffect(()=>{if(n){const x=document.querySelector(`[data-slot="kanban-${a(n)?"column":"item"}"][data-value="${n}"]`);if(x){const m=x.getBoundingClientRect();u({width:m.width,height:m.height})}}else u(null)},[n]);const c={width:o==null?void 0:o.width,height:o==null?void 0:o.height},s=v.useMemo(()=>n?typeof t=="function"?t({value:n,variant:a(n)?"column":"item"}):t:null,[n,t,a]);return e.jsx(st,{dropAnimation:yt,children:e.jsx("div",{"data-slot":"kanban-overlay","data-dragging":!0,style:c,className:L("pointer-events-none",r,n?"!cursor-grabbing":""),children:s})})}const Nt="",Ot={apiurl:Nt},{apiurl:$t}=Ot;function ee({cmd:t,cmd_url:r=null,method:n="GET",type:a="json",data:o={},header:u={},fileList:c=[],fileObj:s={}}){var y,j;n=n.toUpperCase(),a=a.toLowerCase();let x=r??`${$t}/${t}`,m={method:n,headers:{"Content-Type":"application/json",...u}};if(c.length||((y=Object.keys(s))==null?void 0:y.length)>0){let l=new FormData;m.headers["Content-Type"]="multipart/form-data",[...c].forEach(f=>{l.append("files",f)}),(j=Object.keys(s))==null||j.map(f=>{Array.isArray(s[f])?[...s[f]].forEach(S=>{l.append(f,S)}):l.append(f,s[f])}),Object.keys(o).map(f=>{l.append(f,o[f])}),o=l}switch(n){case"POST":case"PUT":case"DELETE":m.data=o;break;case"GET":m.params=o;break}return ut({method:n,url:x,...m,withCredentials:!1}).then(l=>({ok:l.status=="200"||l.status=="403",status:l.status,body:l.data})).catch(l=>{let p=l.response;if(p)return{ok:p.status=="200",status:p.status,body:p.data};throw new Error({ok:!1,status:404,body:l.message})})}const Lt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/kanban!A:G?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Pt=async()=>await ee({method:"GET",cmd_url:"https://sheets.googleapis.com/v4/spreadsheets/1ehRPqqtjiyiZeCXwOqalwgaMIFyE8kL2At4rUKp36Ug/values/columns!A:B?alt=json&key=AIzaSyDPwaw0jfTbUMM1qrdEwB4ZUivo8dBdEbA"}),Ft=async({list:t=[]})=>await ee({method:"GET",cmd_url:`https://script.google.com/macros/s/${localStorage.getItem("sheet")}/exec`,data:{list:JSON.stringify(t)}}),Tt=t=>t.map(r=>({id:r[0],title:r[1],jiraId:r[2],des:r[3],task:r[4],priority:r[5],assignee:r[6]})),te=H({open:!1});function kt(){var o,u;const t=ae({queryKey:["getGoogleSheetIssue"],queryFn:()=>Lt()}),r=ae({queryKey:["getGoogleSheetTask"],queryFn:()=>Pt()}),n=Tt(((o=t==null?void 0:t.data)==null?void 0:o.values)||[]),a=((u=r==null?void 0:r.data)==null?void 0:u.values)||[];return e.jsx("div",{style:{paddingTop:"80px"},className:"p-4 grid h-screen grid-rows-[var(--header-height)_1fr_6rem] overflow-x-hidden sm:grid-rows-[var(--header-height)_1fr_var(--header-height)]",children:e.jsx(Rt,{tasks:a,issues:n})})}function Se({task:t,asHandle:r,...n}){const[,a]=T(te),o=e.jsx("div",{className:"rounded-md border bg-card p-3 shadow-xs",onClick:()=>a({open:!0,task:t}),children:e.jsxs("div",{className:"flex flex-col gap-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"line-clamp-1 font-medium text-sm",children:t.title}),e.jsx(we,{variant:t.priority==="high"?"destructive":t.priority==="medium"?"primary":"warning",appearance:"outline",className:"pointer-events-none h-5 rounded-sm px-1.5 text-[11px] capitalize shrink-0",children:t.priority})]}),e.jsxs("div",{className:"flex items-center justify-between text-muted-foreground text-xs",children:[t.jiraId&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"line-clamp-1",children:t.jiraId})}),t.assignee&&e.jsx("time",{className:"text-[10px] tabular-nums whitespace-nowrap",children:t.assignee})]})]})});return e.jsx(St,{value:t.id,...n,children:r?e.jsx(It,{children:o}):o})}function ge({value:t,tasks:r,isOverlay:n,...a}){return e.jsxs(Dt,{value:t,...a,className:"rounded-md border bg-card p-2.5 shadow-xs",children:[e.jsx("div",{className:"flex items-center justify-between mb-2.5",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"font-semibold text-sm",children:t}),e.jsx(we,{variant:"secondary",children:r.length})]})}),e.jsx(Et,{value:t,className:"flex flex-col gap-2.5 p-0.5",children:r.map(o=>e.jsx(Se,{task:o,asHandle:!n},o.id))})]})}const Ie=H(!1);function Rt({tasks:t,issues:r}){const[n,a]=q.useState({}),[o,u]=q.useState(!1),[c]=T(Ie),[s,x]=T(te),m=Je({mutationFn:Ft});v.useEffect(()=>{if(Array.isArray(r)&&Array.isArray(t)){let l={};t==null||t.map(p=>{let f=p[0];l[f]=r==null?void 0:r.filter(C=>C.task==f)}),a(l)}},[r,t]),v.useEffect(()=>{var l;if(o){console.log("handle change google sheet"),u(!1);let p=[];(l=Object.keys(n))==null||l.map(f=>{let C=n[f].map(S=>[S.id,S.title,S.jiraId,S.des,f,S.priority,S.assignee]);p=p.concat(C)}),m.mutate({list:p},{onSuccess:f=>console.log(f)})}},[c]);const y=l=>{u(!0),a(l)},j=(l,p)=>{var f,C,S,O;if(l!=null&&l.id){let w=JSON.parse(JSON.stringify(n));(f=Object.keys(n))==null||f.map(i=>{w[i]=w[i].map(g=>(g==null?void 0:g.id)==(l==null?void 0:l.id)?{...g,...l}:g)});let D=[];(C=Object.keys(w))==null||C.map(i=>{let g=w[i].map(d=>[d.id,d.title,d.jiraId,d.des,i,d.priority,d.assignee]);D=D.concat(g)}),m.mutate({list:D},{onSuccess:()=>(a(w),p==null?void 0:p())})}else{let w=JSON.parse(JSON.stringify(n));const D=crypto.randomUUID().split("-")[0],i=(S=t==null?void 0:t[0])==null?void 0:S[0];w[i]=w[i].concat([{...l,id:D}]);let g=[];(O=Object.keys(w))==null||O.map(d=>{let h=w[d].map(b=>[b.id,b.title,b.jiraId,b.des,d,b.priority,b.assignee]);g=g.concat(h)}),m.mutate({list:g},{onSuccess:()=>(a(w),p==null?void 0:p())})}};return e.jsxs(e.Fragment,{children:[e.jsxs(Ct,{value:n,onValueChange:y,getItemValue:l=>l.id,children:[e.jsx(wt,{className:"grid auto-rows-fr grid-cols-4",children:Object.entries(n).map(([l,p])=>e.jsx(ge,{value:l,tasks:p},l))}),e.jsx(At,{children:({value:l,variant:p})=>{if(p==="column"){const C=n[l]||[];return e.jsx(ge,{value:l,tasks:C,isOverlay:!0})}const f=Object.values(n).flat().find(C=>C.id===l);return f?e.jsx(Se,{task:f}):null}})]}),!!s.open&&e.jsx(Q,{open:s.open,onClose:()=>x({open:!1}),fullWidth:!0,maxWidth:"lg",children:e.jsx(Ut,{task:s.task,onClose:()=>x({open:!1}),onOk:j})})]})}const Ut=({task:t={id:null,title:"",jiraId:"",des:"",task:"",priority:"",assignee:""},onClose:r,onOk:n})=>{const[a,o]=v.useState(t);return e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:t!=null&&t.id?"Edit Task":"Create Task"}),e.jsxs(V,{sx:{"& .MuiTextField-root":{mb:2}},children:[e.jsx(J,{label:"Title",variant:"standard",value:(a==null?void 0:a.title)||"",onChange:u=>o(c=>({...c,title:u.target.value})),fullWidth:!0}),e.jsx(J,{label:"jiraId",variant:"standard",defaultValue:(a==null?void 0:a.jiraId)||"",onChange:u=>o(c=>({...c,jiraId:u.target.value})),fullWidth:!0}),e.jsx(J,{label:"Des",variant:"standard",defaultValue:(a==null?void 0:a.des)||"",onChange:u=>o(c=>({...c,des:u.target.value})),fullWidth:!0})]}),e.jsxs(X,{children:[e.jsx(me,{onClick:r,children:"Cancel"}),e.jsx(me,{onClick:()=>n(a,r),children:"OK"})]})]})},Bt={mid:null,name:"訪客",account:null,email:null,sso:null,lastLoginDT:null,isLogin:null,refetch:null};B(K((t,r)=>({...Bt,setAccount:n=>t({...n,isLogin:!((n==null?void 0:n.mid)==0||!(n!=null&&n.mid))})})));const pe={open:!1,title:"",content:"",handleAgree:()=>{},handleDisagree:()=>{}},Kt=B(K((t,r)=>({...pe,setAlert:n=>t({...pe,...n,open:!0}),closeAlert:()=>t({open:!1})}))),Mt={isSidebarOpen:!0},Ee=B(K((t,r)=>({...Mt,setSidebarOpen:(n=null)=>t(a=>({isSidebarOpen:n!==null?n:!a.isSidebarOpen}))}))),he={open:!1,title:"",content:null,actions:null,body:null},zt=B(K((t,r)=>({...he,setDialog:n=>t({...he,...n,open:!0}),closeDialog:()=>t({open:!1})})));function Wt(t){const{title:r,name:n,logout:a}=t,{setSidebarOpen:o}=Ee();mt();const[,u]=T(te);return e.jsx(P,{sx:{flexGrow:1},children:e.jsx(Fe,{position:"fixed",sx:{zIndex:c=>c.zIndex.drawer+1,background:"#1f1f1f"},children:e.jsxs(Te,{children:[e.jsx($,{variant:"h6",component:"div",children:r}),e.jsx(P,{sx:{flexGrow:1}}),e.jsx(W,{style:{color:"white"},onClick:()=>u({open:!0}),children:e.jsx(ke,{})})]})})})}const A={SELECTED:"selected",SENDING:"sending",SENT:"sent",FAILED:"failed",RECEIVED:"received",DOWNLOADED:"downloaded"},Gt=H(!1);function _t({roomId:t,isHost:r}){const[n,a]=v.useState(null),[o,u]=T(Gt),c=v.useRef(null),[s,x]=v.useState([]),[m,y]=v.useState([]),j=v.useRef({}),{setSnackMsg:l}=Y();v.useEffect(()=>{let i;if(t)return r?(i=new de(t),console.log(`Host attempting to open Peer with ID: ${t}`)):(i=new de(void 0),console.log("Joiner attempting to open Peer with a random ID")),a(i),()=>{i&&!(i!=null&&i.destroyed)&&(console.log("Destroying peer instance:",i.id),i.destroy()),a(null),x([]),y([])}},[t,r]),v.useEffect(()=>{if(!n)return;n.removeAllListeners();const i=d=>console.error("PeerJS error:",d);n.on("error",i);const g=d=>{c.current=d,d.on("open",()=>{u(!0),console.log(`DataConnection open with ${d.peer}`)}),d.on("close",()=>{u(!1),c.current=null,console.log(`DataConnection closed with ${d.peer}`)}),d.on("error",h=>{console.error(`DataConnection error with ${d.peer}:`,h),u(!1)}),d.on("data",h=>{if(r)h.type==="file-received-ack"?(console.log(`Host: ACK for file ${h.fileId}`),x(b=>b.map(E=>E.id===h.fileId?{...E,status:A.SENT}:E))):h.type==="file-receive-error"&&(console.error(`Host: Joiner reported error for file ${h.fileId}: ${h.error}`),x(b=>b.map(E=>E.id===h.fileId?{...E,status:A.FAILED}:E)));else if(console.log("blob in",h),h.type==="file-metadata")console.log("Joiner: Received file metadata",h),j.current[h.fileId]=h;else if(h instanceof Blob||h instanceof ArrayBuffer||h instanceof Uint8Array){let b=null;const E=Object.keys(j.current).filter(I=>!m.some(N=>N.id===I));if(E.length>0){const I=E[E.length-1];I&&j.current[I]&&(b=j.current[I])}if(b){const{fileId:I,name:N,mimeType:M,size:U}=b;console.log(`Joiner: Received blob for ${N} (ID: ${I})`);const ne=h instanceof Blob?h:new Blob([h],{type:M}),Ae=URL.createObjectURL(ne);y(Ne=>[...Ne,{id:I,name:N,type:M,size:U,blobUrl:Ae,blobObject:ne,status:A.RECEIVED}]),d.send({type:"file-received-ack",fileId:I}),delete j.current[I]}else console.warn("Joiner: Received blob/arraybuffer without matching metadata or ID.")}else h.type==="batch-meta"&&console.log("Joiner: Received batch metadata",h)})};r?(n.on("open",d=>console.log(`Host Peer opened: ${d}`)),n.on("connection",g)):n.on("open",d=>{if(console.log(`Joiner Peer opened: ${d}`),t){const h=n.connect(t);g(h)}})},[n,t,r,m]);const p=i=>{const g=Array.from(i.target.files).map(d=>({id:ht(),name:d.name,size:d.size,type:d.type,previewUrl:URL.createObjectURL(d),status:A.SELECTED,fileObject:d}));x(d=>[...d,...g]),i.target.value=null},f=async()=>{if(!o||!c.current){alert("連線未建立!");return}const i=s.filter(g=>g.status===A.SELECTED);if(i.length===0){alert("沒有已選擇的檔案可傳送。");return}c.current.send({type:"batch-meta",totalFiles:i.length});for(const g of i){x(d=>d.map(h=>h.id===g.id?{...h,status:A.SENDING}:h));try{const d={type:"file-metadata",fileId:g.id,name:g.name,mimeType:g.type,size:g.size};c.current.send(d)}catch(d){console.error(`Host: Error sending file ${g.name}:`,d),x(h=>h.map(b=>b.id===g.id?{...b,status:A.FAILED}:b))}}for(const g of i)try{await new Promise(d=>setTimeout(d,50)),c.current.send(g.fileObject),console.log(`Host: Sent ${g.name} (ID: ${g.id})`)}catch(d){console.error(`Host: Error sending file ${g.name}:`,d),x(h=>h.map(b=>b.id===g.id?{...b,status:A.FAILED}:b))}},C=i=>{const g=m.find(d=>d.id===i);if(g){const d=document.createElement("a");d.href=g.blobUrl,d.download=g.name,document.body.appendChild(d),d.click(),document.body.removeChild(d),y(h=>h.map(b=>b.id===i?{...b,status:A.DOWNLOADED}:b))}},S=async()=>{const i=m.filter(g=>g.status===A.RECEIVED&&g.blobUrl);if(i.length===0){l({message:"沒有可下載的新檔案。"});return}for(let g=0;g<i.length;g++){const d=i[g];console.log(`Auto-downloading ${g+1}/${i.length}: ${d.name}`),C(d.id),g<i.length-1&&await new Promise(h=>setTimeout(h,500))}l({message:`${i.length} 個檔案已開始下載。`})},O=m.some(i=>i.status===A.RECEIVED&&i.blobUrl),w=i=>{const g=s.filter(d=>d.id!==i);x(g)},D=(i,g=null)=>{switch(i){case A.SELECTED:return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"已選擇",children:e.jsx(ze,{color:"action"})}),e.jsx(F,{title:"刪除",children:e.jsx(W,{sx:{ml:1},onClick:()=>w(g),children:e.jsx(We,{color:"action"})})})]});case A.SENDING:return e.jsx(F,{title:"傳送中",children:e.jsx(Me,{color:"primary",className:"animate-spin"})});case A.SENT:return e.jsx(F,{title:"已傳送",children:e.jsx(ie,{color:"success"})});case A.FAILED:return e.jsx(F,{title:"失敗",children:e.jsx(Ke,{color:"error"})});default:return null}};return e.jsx("div",{children:e.jsx(ye,{children:e.jsx(Ce,{path:"/transfer",element:e.jsxs(Re,{elevation:3,className:"p-4 md:p-6 max-w-2xl mx-auto my-4",children:[e.jsxs($,{variant:"h5",component:"h2",gutterBottom:!0,className:"text-center text-indigo-600",children:["WHL's 檔案傳輸 (",r?"Host":"Joiner",")"]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs($,{children:["Peer ID: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:(n==null?void 0:n.id)||"..."})]}),r&&e.jsxs($,{children:["房號: ",e.jsx("span",{className:"font-mono bg-gray-100 p-1 rounded",children:t})]}),e.jsxs($,{children:["連線狀態:",e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full text-white ${o?"bg-green-500":"bg-red-500"}`,children:o?"已連線":"未連線"})]})]}),r&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsx($,{variant:"h6",gutterBottom:!0,children:"傳送檔案"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(k,{variant:"outlined",component:"label",disabled:!o,children:["選擇檔案",e.jsx("input",{type:"file",hidden:!0,multiple:!0,onChange:p})]}),e.jsx(k,{variant:"contained",color:"primary",onClick:f,disabled:!o||!s.some(i=>i.status===A.SELECTED),sx:{ml:2},className:"ml-2",children:"傳送已選擇的"})]}),s.length>0&&e.jsx(se,{dense:!0,children:s.map(i=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:i.previewUrl,alt:i.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:i.name}),secondary:`${(i.size/1024).toFixed(1)} KB - 狀態: ${i.status}`}),e.jsx("div",{className:"ml-auto",children:D(i.status,i.id)})]},i.id))})]}),!r&&e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs($,{variant:"h6",gutterBottom:!0,component:"div",children:[" ","接收到的檔案"]}),m.length>0&&e.jsx(k,{variant:"contained",size:"small",startIcon:e.jsx(Ue,{}),onClick:S,disabled:!O||!o,className:"bg-teal-500 hover:bg-teal-700 disabled:bg-gray-300",children:"下載全部未下載"})]}),m.length===0&&o&&e.jsx($,{variant:"body2",color:"textSecondary",children:"等待接收檔案中..."}),m.length===0&&!o&&e.jsx($,{variant:"body2",color:"textSecondary",children:"請先連線至 Host。"}),m.length>0&&e.jsx(se,{dense:!0,children:m.map(i=>e.jsxs(re,{divider:!0,className:"hover:bg-gray-50",children:[e.jsx("img",{src:i.blobUrl,alt:i.name,className:"w-12 h-12 object-cover mr-3 rounded"}),e.jsx(oe,{primary:e.jsx("span",{className:"font-medium",children:i.name}),secondary:`${(i.size/1024).toFixed(1)} KB`}),e.jsx(F,{title:"下載檔案",children:e.jsx(W,{color:"primary",onClick:()=>C(i.id),disabled:i.status===A.DOWNLOADED,children:e.jsx(Be,{})})}),i.status===A.DOWNLOADED&&e.jsx(F,{title:"已下載",children:e.jsx(ie,{color:"success",className:"ml-2"})})]},i.id))})]})]})})})})}function Ht(){const[t,r]=gt(),n=t.get("roomId"),a=t.get("isHost");return e.jsxs(P,{sx:{flex:"1 1 auto"},children:[e.jsx(_t,{roomId:n,isHost:a}),e.jsx(ye,{children:e.jsx(Ce,{path:"/",element:e.jsx(kt,{})})})]})}function Jt(t){const{title:r}=t;return e.jsx("footer",{children:e.jsx("div",{className:"footer-content footer-info flex aic",children:e.jsx("div",{className:"flex rowTitle",children:"SAF Kanban. WHL. All rights reserved."})})})}function qt(){return z("(min-width:900px)"),e.jsx(P,{sx:{display:"flex",height:"100%",width:"100%"},children:e.jsxs(P,{component:"main",sx:{flexGrow:1,p:0,display:"flex",flexDirection:"column"},children:[e.jsx(Ht,{}),e.jsx(Jt,{title:null})]})})}function Qt(){const{open:t,closeAlert:r,title:n,content:a,handleAgree:o,handleDisagree:u}=Kt(c=>c);return e.jsxs(Q,{open:t,onClose:r,children:[e.jsx(Z,{children:n}),e.jsx(V,{children:e.jsx(Ge,{sx:{whiteSpace:"pre-line"},children:a})}),e.jsxs(X,{children:[e.jsx(k,{onClick:r,children:"取消"}),e.jsx(k,{onClick:()=>o(r),autoFocus:!0,children:"確認"})]})]})}function Zt(t){var C;const{children:r,margin:n=15,sx:a={},content_sx:o={},data:u=null,onlyProps:c=!1,noDrawer:s=!1}=t,x=((C=Ee())==null?void 0:C.isDrawerOpen)&&!s,m=z(x?"(min-width:1440px)":"(min-width:1200px)"),y=z(x?"(min-width:1232px)":"(min-width:992px)"),j=z(x?"(min-width:1008px)":"(min-width:768px)");let l=m?"1170px":y?"970px":j?"750px":"100%",p=(u==null?void 0:u.length)<3?`${100/u.length}%`:m?1170/3:y?970/3:j?750/2:l;const f={content_width:l,margin:`${n}px`,width:p,width_margin:typeof p!="string"?p-n*2:`calc(${p} - ${n*2}px)`,lg:m,md:y,xs:j};return c==!0?e.jsx(v.Fragment,{children:v.cloneElement(r,{...f})}):e.jsx(P,{className:"flex flex-1-1 jcsb flex-col aic",sx:{...a},children:e.jsx(P,{sx:{width:l,display:"flex",flexWrap:"wrap",...o},children:v.cloneElement(r,{...f})})})}const Vt=_e(Q)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)}}));function Xt(t){const{isRwdWidth:r}=t;return r?e.jsx(Zt,{onlyProps:!0,noDrawer:!0,children:e.jsx(xe,{...t})}):e.jsx(xe,{...t})}const xe=t=>{const{content_width:r,open:n,title:a,content:o,actions:u,body:c,closeDialog:s,disableScrollLock:x,fullWidth:m,fullHeight:y,maxWidth:j,fullScreen:l,isRwdWidth:p,contentProps:f={}}=t,C=p?{sx:{width:"100%",maxWidth:`${r} !important`,height:y?"100%":"auto"}}:{fullWidth:m,maxWidth:j,fullScreen:l};return e.jsxs(Vt,{onClose:s,open:n,disableScrollLock:!!x,...p?{}:C,PaperProps:{...p?C:{}},children:[e.jsxs(P,{className:"flex aic jcsb",sx:{p:1},children:[e.jsx(Z,{sx:{m:0,p:0,pl:1},children:a}),e.jsx(W,{onClick:s,sx:{color:S=>S.palette.grey[500]},children:e.jsx(He,{})})]}),c?v.cloneElement(c,{closeDialog:s}):e.jsxs(e.Fragment,{children:[e.jsx(V,{dividers:!0,sx:{...f},children:!!o&&v.cloneElement(o,{closeDialog:s})}),!!u&&e.jsx(X,{children:v.cloneElement(u,{closeDialog:s})})]})]})},Yt=()=>{const{...t}=zt();return e.jsxs(e.Fragment,{children:[e.jsx(Wt,{title:"SAF Kanban"}),e.jsx(qt,{}),e.jsx(Qt,{}),e.jsx(ft,{}),e.jsx(Xt,{...t})]})},en={},G=H(en,async(t,r,n)=>{let a=t(G);r(G,{...a,...n})}),tn=()=>{const[{...t},r]=T(G),n=({key:a,body:o})=>{console.log(`apiDataAtom log (${a}):`,{...t,[a]:o}),r({[a]:o})};return{...dt(G),setApiData:n}},nn=()=>{const{setSnackMsg:t}=Y(s=>s),{setApiData:r}=tn(),n=(s=[])=>{let x="";s==null||s.map((m,y)=>{x+=(y==0?"":`

`)+((m==null?void 0:m.displayName)||(m==null?void 0:m.field))+`：
`+(m==null?void 0:m.error)}),setAlert({title:"錯誤",content:x,handleAgree:m=>m()})},a=(s,x,m)=>{console.log("onError",s,x),t({message:"API發生未知錯誤"})},o=async(s,x)=>{var y,j,l,p,f,C,S,O,w,D,i;((j=(y=x==null?void 0:x.queryKey)==null?void 0:y[0])==null?void 0:j[0])=="_"&&r({key:(p=(l=x==null?void 0:x.queryKey)==null?void 0:l[0])==null?void 0:p.replace("_",""),body:{data:s==null?void 0:s.body,refetch:(f=x==null?void 0:x.options)==null?void 0:f.queryFn}});const m=((C=s==null?void 0:s.body)==null?void 0:C.status)!==null&&((S=s==null?void 0:s.body)==null?void 0:S.status)!==void 0?(O=s==null?void 0:s.body)==null?void 0:O.status:null;m!==null&&Array.isArray((w=s==null?void 0:s.body)==null?void 0:w.errorArray)?n((D=s==null?void 0:s.body)==null?void 0:D.errorArray):m!==null&&t({message:(i=s==null?void 0:s.body)==null?void 0:i.message}),!(s!=null&&s.ok)&&m==null&&!(s!=null&&s.pages)&&t({message:"API發生未知錯誤！"})},u=(s,x)=>{},c=new qe({queryCache:new Ze({onSuccess:o,onError:a,onSettled:u}),mutationCache:new Qe({onSuccess:o,onError:a}),defaultOptions:{queries:{refetchOnWindowFocus:!1,select:s=>{var y,j,l,p;let m=(((y=s==null?void 0:s.body)==null?void 0:y.status)!==null&&((j=s==null?void 0:s.body)==null?void 0:j.status)!==void 0?(l=s==null?void 0:s.body)==null?void 0:l.status:null)==null&&s.body||null;if(Array.isArray(s==null?void 0:s.pages)){let f=[];(p=s==null?void 0:s.pages)==null||p.map((C,S)=>{f[S]=(C==null?void 0:C.body)||C}),m={...s,pages:f}}return m}}}});return e.jsx(Ve,{client:c,children:e.jsx(pt,{basename:"/SAF_Kanban/",children:e.jsx(Yt,{})})})},sn=document.getElementById("root");Oe.createRoot(sn).render(e.jsx(nn,{}));
